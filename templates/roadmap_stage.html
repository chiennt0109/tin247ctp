{% extends 'base.html' %}
{% block title %}{{ stage.title }} | IT Contest OJ{% endblock %}

{% block extra_head %}
<style>
  body { background-color: #f8fafc; }
  pre { white-space: pre-wrap; font-size: 0.95rem; }
  textarea { font-family: "Fira Code", monospace; font-size: 0.95rem; }
  .topic-item {
    cursor: pointer; border-left: 4px solid transparent; transition: 0.25s;
    border-radius: 4px; padding: 6px 10px;
  }
  .topic-item:hover { background-color: #f1f5f9; }
  .topic-item.active { background-color: #e0f2fe; border-left-color: #0d6efd; }
  .code-box { font-family: "Fira Code", monospace; font-size: 0.9rem; }
  #output-box { min-height: 120px; max-height: 400px; overflow-y: auto; }
  #topic-content { opacity: 0; transition: opacity 0.4s ease-in-out; }
  #topic-content.show { opacity: 1; }

  /* üß≠ N√∫t chuy·ªÉn giai ƒëo·∫°n c·ªë ƒë·ªãnh */
  .stage-nav-btn {
    position: fixed;
    bottom: 50px;
    z-index: 1000;
    background: #0d6efd;
    color: #fff;
    border-radius: 50px;
    padding: 10px 20px;
    font-size: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    text-decoration: none;
    transition: all 0.3s ease;
  }
  .stage-nav-btn:hover { background: #2563eb; transform: scale(1.05); }
  .stage-prev { left: 30px; }
  .stage-next { right: 30px; }
  .stage-nav-btn[data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 120%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(30,41,59,0.9);
    color: #fff;
    font-size: 13px;
    padding: 6px 10px;
    border-radius: 6px;
    white-space: nowrap;
  }

  @media (max-width: 992px) {
    .stage-nav-btn { display: none; }
  }
</style>
{% endblock %}

{% block content %}
<h4 class="fw-bold text-danger">{{ stage.title }}</h4>
<p class="text-muted mb-4">{{ stage.summary }}</p>

<div class="row">
  <!-- SIDEBAR TR√ÅI -->
  <div class="col-lg-4 border-end">
    <h5 class="fw-semibold text-secondary mb-3">üìò N·ªôi dung</h5>
    <div id="topic-list">
      {% for topic in stage.topics %}
        <div class="topic-item mb-1" data-index="{{ forloop.counter0 }}">
          <span class="fw-semibold text-primary">{{ topic.title }}</span><br>
          <small class="text-muted">{{ topic.summary|truncatechars:60 }}</small>
        </div>
      {% empty %}
        <p class="text-muted fst-italic">Ch∆∞a c√≥ n·ªôi dung cho giai ƒëo·∫°n n√†y.</p>
      {% endfor %}
    </div>
  </div>

  <!-- N·ªòI DUNG CHI TI·∫æT -->
  <div class="col-lg-8 ps-4">
    <div id="topic-content" class="show">
      <h6 class="fw-bold text-primary">
        üëâ H√£y ch·ªçn m·ªôt m·ª•c ·ªü c·ªôt tr√°i ƒë·ªÉ xem n·ªôi dung chi ti·∫øt.
      </h6>
    </div>

    <hr class="my-4">

    <h5 class="fw-bold text-secondary mb-3">üßÆ Th·ª±c h√†nh ‚Äì Vi·∫øt v√† ch·∫°y code</h5>
    <form id="run-form" class="mb-3">
      {% csrf_token %}
      <div class="row mb-2">
        <div class="col-md-4">
          <label class="form-label">Ng√¥n ng·ªØ</label>
          <select id="language" name="language" class="form-select form-select-sm">
            <option value="cpp">C++</option>
            <option value="python">Python</option>
            <option value="pypy">PyPy</option>
          </select>
        </div>
        <div class="col-md-8">
          <label class="form-label">Input (n·∫øu c√≥)</label>
          <textarea id="input-data" name="input" rows="2" class="form-control" placeholder="Nh·∫≠p d·ªØ li·ªáu test..."></textarea>
        </div>
      </div>

      <label class="form-label fw-semibold">üíª Code c·ªßa b·∫°n</label>
      <textarea id="source-code" name="code" rows="10" class="form-control" placeholder="Nh·∫≠p code t·∫°i ƒë√¢y..."></textarea>

      <div class="text-end mt-3">
        <button type="button" id="reset-btn" class="btn btn-outline-secondary btn-sm me-2">‚Ü©Ô∏è Reset v√≠ d·ª•</button>
        <button type="submit" class="btn btn-success btn-lg">‚ñ∂ Ch·∫°y code</button>
      </div>
    </form>

    <div>
      <h6 class="fw-bold text-secondary">üì§ K·∫øt qu·∫£:</h6>
      <pre id="output-box" class="bg-dark text-light p-3 rounded"></pre>
    </div>
  </div>
</div>

<!-- üåü N√öT CHUY·ªÇN GIAI ƒêO·∫†N -->
{% if prev_stage %}
  <a href="/roadmap/stage/{{ prev_stage.id }}/"
     class="stage-nav-btn stage-prev"
     data-tooltip="{{ prev_stage.title }}">‚¨ÖÔ∏è Tr∆∞·ªõc</a>
{% endif %}
{% if next_stage %}
  <a href="/roadmap/stage/{{ next_stage.id }}/"
     class="stage-nav-btn stage-next"
     data-tooltip="{{ next_stage.title }}">Sau ‚û°Ô∏è</a>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
  const topics = {{ stage.topics|safe }};
  const topicList = document.getElementById("topic-list");
  const topicContent = document.getElementById("topic-content");
  const codeBox = document.getElementById("source-code");
  const resetBtn = document.getElementById("reset-btn");
  const outputBox = document.getElementById("output-box");
  let currentIndex = -1;

  function fadeIn(html) {
    topicContent.classList.remove("show");
    setTimeout(() => {
      topicContent.innerHTML = html;
      topicContent.classList.add("show");
      const isLoggedIn = {{ user.is_authenticated|yesno:"true,false" }};
      if (isLoggedIn && document.getElementById("locked")) {
        document.getElementById("locked").style.display = "none";
        document.getElementById("sol").style.display = "block";
      }
    }, 200);
  }

  topicList.addEventListener("click", e => {
    const item = e.target.closest(".topic-item");
    if (!item) return;
    topicList.querySelectorAll(".topic-item").forEach(i => i.classList.remove("active"));
    item.classList.add("active");

    currentIndex = parseInt(item.dataset.index);
    const t = topics[currentIndex];
    if (!t) return;

    // Ch·ªâ load n·ªôi dung, kh√¥ng l·ªìng <html> ƒë·ªÉ tr√°nh l·ªói click
    fetch(t.html_file)
      .then(res => res.text())
      .then(html => fadeIn(html))
      .catch(() => fadeIn(`<p class='text-danger'>‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c n·ªôi dung.</p>`));

    const lang = document.getElementById("language").value;
    codeBox.value = (lang === "cpp") ? t.sample_cpp : t.sample_py;
    outputBox.textContent = "";
  });

  resetBtn.addEventListener("click", () => {
    if (currentIndex >= 0) {
      const t = topics[currentIndex];
      const lang = document.getElementById("language").value;
      codeBox.value = (lang === "cpp") ? t.sample_cpp : t.sample_py;
      outputBox.textContent = "";
    }
  });

  document.getElementById("run-form").addEventListener("submit", async e => {
    e.preventDefault();
    const data = new FormData(e.target);
    outputBox.textContent = "‚è≥ ƒêang ch·∫°y code...";
    try {
      const resp = await fetch("/roadmap/run/", { method: "POST", body: data });
      const res = await resp.json();
      outputBox.textContent = (res.output || res.error || "").trim();
    } catch (err) {
      outputBox.textContent = "‚ùå L·ªói khi g·ª≠i y√™u c·∫ßu: " + err;
    }
  });
</script>
{% endblock %}
