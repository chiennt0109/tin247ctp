{% extends 'base.html' %}

{% block title %}{{ stage.title }} | IT Contest OJ{% endblock %}

{% block extra_head %}
<style>
  pre { white-space: pre-wrap; font-size: 0.95rem; }
  textarea { font-family: "Fira Code", monospace; font-size: 0.95rem; }
  .topic-item { cursor: pointer; border-left: 4px solid transparent; transition: 0.25s; }
  .topic-item:hover { background-color: #f1f5f9; }
  .topic-item.active { background-color: #e0f2fe; border-left-color: #0d6efd; }
  .code-box { font-family: "Fira Code", monospace; font-size: 0.9rem; }
  #output-box { min-height: 120px; max-height: 400px; overflow-y: auto; }
  .section-header { border-left: 5px solid #0d6efd; padding-left: 10px; }

  /* ğŸŒˆ Hiá»‡u á»©ng mÆ°á»£t khi thay Ä‘á»•i ná»™i dung */
  #topic-content {
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
  }
  #topic-content.show { opacity: 1; }

  /* ğŸ¯ NÃºt chuyá»ƒn giai Ä‘oáº¡n cá»‘ Ä‘á»‹nh á»Ÿ biÃªn */
  .stage-nav-btn {
    position: fixed;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1055; /* cao hÆ¡n sidebar á»Ÿ topic detail */
    padding: 10px 14px;
    font-size: 0.95rem;
    border-radius: 50px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.25);
    transition: all 0.3s ease;
    white-space: nowrap;
  }
  .stage-nav-btn:hover {
    transform: translateY(-50%) scale(1.05);
    text-decoration: none;
  }
  .stage-prev {
    left: 15px;
    background-color: #f3f4f6;
    color: #0d6efd;
    border: 1px solid #dbeafe;
  }
  .stage-next {
    right: 15px;
    background-color: #0d6efd;
    color: #fff;
  }

  /* Tooltip tÃ¹y chá»‰nh */
  .stage-nav-btn[data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    white-space: nowrap;
    background: rgba(30, 41, 59, 0.9);
    color: #fff;
    font-size: 13px;
    padding: 6px 10px;
    border-radius: 6px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.3);
    pointer-events: none;
  }
  .stage-prev[data-tooltip]:hover::after {
    left: 110%;
  }
  .stage-next[data-tooltip]:hover::after {
    right: 110%;
  }

  @media (max-width: 992px) {
    .stage-nav-btn { display: none; } /* áº¨n trÃªn mobile Ä‘á»ƒ trÃ¡nh che ná»™i dung */
  }
</style>
{% endblock %}

{% block content %}
<h3 class="fw-bold text-primary">{{ stage.title }}</h3>
<p class="text-muted mb-4">{{ stage.summary }}</p>

<div class="row">
  <!-- Cá»˜T TRÃI -->
  <div class="col-md-4 border-end">
    <h5 class="fw-semibold text-secondary mb-3">ğŸ“˜ Ná»™i dung</h5>
    <div id="topic-list">
      {% for topic in stage.topics %}
        <div class="p-2 topic-item" data-index="{{ forloop.counter0 }}">
          <span class="fw-semibold text-primary">{{ topic.title }}</span><br>
          <small class="text-muted">{{ topic.summary|truncatechars:60 }}</small>
        </div>
      {% empty %}
        <p class="text-muted fst-italic">ChÆ°a cÃ³ ná»™i dung cho giai Ä‘oáº¡n nÃ y.</p>
      {% endfor %}
    </div>
  </div>

  <!-- Cá»˜T PHáº¢I -->
  <div class="col-md-8 ps-4">
    <div id="topic-content" class="show">
      <h5 class="fw-bold text-primary">ğŸ‘ˆ HÃ£y chá»n má»™t má»¥c á»Ÿ cá»™t trÃ¡i Ä‘á»ƒ xem ná»™i dung chi tiáº¿t.</h5>
    </div>

    <hr class="my-4">

    <!-- KHUNG EDITOR -->
    <h5 class="fw-bold text-secondary mb-3">ğŸ§® Thá»±c hÃ nh â€“ Viáº¿t vÃ  cháº¡y code</h5>
    <form id="run-form" class="mb-3">
      {% csrf_token %}
      <div class="row mb-2">
        <div class="col-md-4">
          <label class="form-label">NgÃ´n ngá»¯</label>
          <select id="language" name="language" class="form-select form-select-sm">
            <option value="cpp">C++</option>
            <option value="python">Python</option>
            <option value="pypy">PyPy</option>
          </select>
        </div>
        <div class="col-md-8">
          <label class="form-label">Input (náº¿u cÃ³)</label>
          <textarea id="input-data" name="input" rows="2" class="form-control" placeholder="Nháº­p dá»¯ liá»‡u test..."></textarea>
        </div>
      </div>

      <label class="form-label fw-semibold">ğŸ’» Code cá»§a báº¡n</label>
      <textarea id="source-code" name="code" rows="12" class="form-control" placeholder="Nháº­p code táº¡i Ä‘Ã¢y..."></textarea>

      <div class="text-end mt-3">
        <button type="button" id="reset-btn" class="btn btn-outline-secondary btn-sm me-2">â†©ï¸ Reset vÃ­ dá»¥</button>
        <button type="submit" class="btn btn-success btn-lg">â–¶ Cháº¡y code</button>
      </div>
    </form>

    <div>
      <h6 class="fw-bold text-secondary">ğŸ“¤ Káº¿t quáº£:</h6>
      <pre id="output-box" class="bg-dark text-light p-3 rounded"></pre>
    </div>
  </div>
</div>

<!-- ğŸŒŸ NÃºt chuyá»ƒn giai Ä‘oáº¡n cá»‘ Ä‘á»‹nh -->
{% if prev_stage %}
  <a href="/roadmap/stage/{{ prev_stage.id }}/"
     class="stage-nav-btn stage-prev"
     data-tooltip="{{ prev_stage.title }}">
     â¬…ï¸
  </a>
{% endif %}

{% if next_stage %}
  <a href="/roadmap/stage/{{ next_stage.id }}/"
     class="stage-nav-btn stage-next"
     data-tooltip="{{ next_stage.title }}">
     â¡ï¸
  </a>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
  const topics = {{ stage.topics|safe }};
  const topicList = document.getElementById("topic-list");
  const topicContent = document.getElementById("topic-content");
  const codeBox = document.getElementById("source-code");
  const resetBtn = document.getElementById("reset-btn");
  const outputBox = document.getElementById("output-box");

  let currentIndex = -1;

  // ğŸ’¡ Hiá»‡u á»©ng fade khi load ná»™i dung má»›i
  function fadeInContent(html) {
    topicContent.classList.remove("show");
    setTimeout(() => {
      topicContent.innerHTML = html;
      topicContent.classList.add("show");

      // xá»­ lÃ½ áº©n/hiá»‡n lá»i giáº£i sau khi load
      const isLoggedIn = {{ user.is_authenticated|yesno:"true,false" }};
      if (isLoggedIn && document.getElementById("locked")) {
        document.getElementById("locked").style.display = "none";
        document.getElementById("sol").style.display = "block";
      }
    }, 250);
  }

  topicList.addEventListener("click", (e) => {
    const item = e.target.closest(".topic-item");
    if (!item) return;

    topicList.querySelectorAll(".topic-item").forEach(i => i.classList.remove("active"));
    item.classList.add("active");

    currentIndex = parseInt(item.dataset.index);
    const t = topics[currentIndex];
    if (!t) return;

    // Náº¿u cÃ³ ná»™i dung chi tiáº¿t
    if (t.detail && t.detail.length > 100) {
      fadeInContent(t.detail);
    } else {
      const shortHtml = `
        <div class="d-flex justify-content-between align-items-center">
          <h4 class="fw-bold text-primary mb-2">${t.title}</h4>
          <a href="${t.more_url}" class="btn btn-outline-primary btn-sm">ğŸ“– Xem chi tiáº¿t</a>
        </div>
        <p>${t.summary}</p>
        <div class="row">
          <div class="col-md-6">
            <h6 class="text-danger fw-semibold">ğŸ’» C++</h6>
            <pre class="border rounded bg-light p-3 code-box">${t.sample_cpp}</pre>
          </div>
          <div class="col-md-6">
            <h6 class="text-success fw-semibold">ğŸ Python</h6>
            <pre class="border rounded bg-light p-3 code-box">${t.sample_py}</pre>
          </div>
        </div>`;
      fadeInContent(shortHtml);
    }

    const lang = document.getElementById("language").value;
    codeBox.value = (lang === "cpp") ? t.sample_cpp : t.sample_py;
    outputBox.textContent = "";
  });

  resetBtn.addEventListener("click", () => {
    if (currentIndex >= 0) {
      const t = topics[currentIndex];
      const lang = document.getElementById("language").value;
      codeBox.value = (lang === "cpp") ? t.sample_cpp : t.sample_py;
      outputBox.textContent = "";
    }
  });

  document.getElementById("run-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const data = new FormData(e.target);
    outputBox.textContent = "â³ Äang cháº¡y code...";
    try {
      const resp = await fetch("/roadmap/run/", { method: "POST", body: data });
      const res = await resp.json();
      outputBox.textContent = (res.output || res.error || "").trim();
    } catch (err) {
      outputBox.textContent = "âŒ Lá»—i khi gá»­i yÃªu cáº§u: " + err;
    }
  });
</script>
{% endblock %}
