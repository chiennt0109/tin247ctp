<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>{{ stage.title }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    pre { white-space: pre-wrap; font-size: 0.95rem; }
    .code-box { font-family: "Fira Code", monospace; }
    .topic-block:hover { background-color: #f8fafc; transition: 0.3s; }
    .section-header { border-left: 5px solid #0d6efd; padding-left: 10px; }
    textarea { font-family: "Fira Code", monospace; font-size: 0.95rem; }
    #output-box { min-height: 100px; max-height: 400px; overflow-y: auto; }
  </style>
</head>

<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/">üè´ IT Contest OJ</a>
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a href="/problems/" class="nav-link">Problems</a></li>
        <li class="nav-item"><a href="/contests/" class="nav-link">Contests</a></li>
      </ul>
    </div>
  </nav>

  <main class="container bg-white shadow-sm p-4 rounded">
    <h2 class="fw-bold text-primary mb-2">{{ stage.title }}</h2>
    <p class="text-muted mb-4">{{ stage.summary }}</p>

    <!-- ========================== PH·∫¶N L√ù THUY·∫æT ========================== -->
    <h4 class="section-header mt-5 mb-3">üìò L√Ω thuy·∫øt & v√≠ d·ª•</h4>
    {% for topic in stage.topics %}
      <div class="card mb-3 topic-block">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h5 class="fw-bold text-primary">{{ topic.title }}</h5>
            <a href="{{ topic.more_url }}" class="btn btn-link btn-sm text-decoration-none">Chi ti·∫øt ¬ª</a>
          </div>
          <p>{{ topic.summary }}</p>
        </div>
      </div>
    {% empty %}
      <p class="text-muted fst-italic">Ch∆∞a c√≥ n·ªôi dung cho giai ƒëo·∫°n n√†y.</p>
    {% endfor %}

    <!-- ========================== PH·∫¶N TH·ª∞C H√ÄNH ========================== -->
    <h4 class="section-header mt-5 mb-3">üßÆ Th·ª±c h√†nh ‚Äì Vi·∫øt & ch·∫°y code</h4>

    <form id="run-form" class="mt-3">
      {% csrf_token %}
      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Ng√¥n ng·ªØ</label>
          <select name="language" id="language" class="form-select">
            <option value="cpp">C++</option>
            <option value="python">Python</option>
            <option value="pypy">PyPy</option>
          </select>
        </div>
        <div class="col-md-8">
          <label class="form-label">Input (n·∫øu c√≥)</label>
          <textarea id="input-data" name="input" rows="2" class="form-control" placeholder="Nh·∫≠p d·ªØ li·ªáu test..."></textarea>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold">üíª Code c·ªßa b·∫°n</label>
        <textarea id="source-code" name="code" rows="10" class="form-control"
                  placeholder="#include <bits/stdc++.h>\nusing namespace std;\nint main() {\n    int a, b; cin >> a >> b;\n    cout << a + b;\n}">
        </textarea>
      </div>

      <div class="text-end mb-3">
        <button type="submit" class="btn btn-success btn-lg px-4">‚ñ∂ Ch·∫°y code</button>
      </div>
    </form>

    <div class="mt-3">
      <h5 class="fw-bold text-secondary">üì§ K·∫øt qu·∫£:</h5>
      <pre id="output-box" class="bg-dark text-light p-3 rounded"></pre>
    </div>

    <!-- ========================== ƒêI·ªÄU H∆Ø·ªöNG ========================== -->
    <div class="d-flex justify-content-between my-5">
      {% if prev_stage %}
        <a href="/roadmap/stage/{{ prev_stage.id }}/" class="btn btn-outline-secondary">‚¨ÖÔ∏è {{ prev_stage.title }}</a>
      {% else %}
        <span></span>
      {% endif %}
      {% if next_stage %}
        <a href="/roadmap/stage/{{ next_stage.id }}/" class="btn btn-primary">{{ next_stage.title }} ‚û°Ô∏è</a>
      {% endif %}
    </div>
  </main>

  <footer class="text-center mt-5 mb-3 text-muted small">
    ¬© 2025 Chuy√™n Tr·∫ßn Ph√∫ - IT Contest OJ
  </footer>

  <script>
    // X·ª≠ l√Ω g·ª≠i code AJAX
    document.getElementById("run-form").addEventListener("submit", async function (e) {
      e.preventDefault();
      const form = e.target;
      const data = new FormData(form);
      const outputBox = document.getElementById("output-box");
      outputBox.textContent = "‚è≥ ƒêang ch·∫°y code...";

      try {
        const resp = await fetch("/roadmap/run/", {
          method: "POST",
          body: data,
        });
        const res = await resp.json();
        outputBox.textContent = res.output || ("‚ö†Ô∏è L·ªói: " + (res.error || "Kh√¥ng x√°c ƒë·ªãnh"));
      } catch (err) {
        outputBox.textContent = "‚ùå L·ªói khi g·ª≠i y√™u c·∫ßu: " + err;
      }
    });
  </script>
</body>
</html>
