<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>{{ stage.title }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    pre { white-space: pre-wrap; font-size: 0.95rem; }
    .code-box { font-family: "Fira Code", monospace; }
    .topic-block:hover { background-color: #f8fafc; transition: 0.3s; }
    .section-header { border-left: 5px solid #0d6efd; padding-left: 10px; }
  </style>
</head>

<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/">üè´ IT Contest OJ</a>
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a href="/problems/" class="nav-link">Problems</a></li>
        <li class="nav-item"><a href="/contests/" class="nav-link">Contests</a></li>
      </ul>
    </div>
  </nav>

  <main class="container bg-white shadow-sm p-4 rounded">
    <h2 class="fw-bold text-primary mb-2">{{ stage.title }}</h2>
    <p class="text-muted mb-4">{{ stage.summary }}</p>

    <!-- ========== L√ù THUY·∫æT + V√ç D·ª§ ========== -->
    <h4 class="section-header mt-5 mb-3">üìò L√Ω thuy·∫øt & v√≠ d·ª•</h4>
    {% for topic in stage.topics %}
      <div class="card mb-4 topic-block">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h5 class="fw-bold text-primary">{{ topic.title }}</h5>
            <a href="{{ topic.more_url }}" class="btn btn-link btn-sm text-decoration-none">Chi ti·∫øt ¬ª</a>
          </div>
          <p>{{ topic.summary }}</p>

          <div class="row">
            {% if "C++" in topic.lang_support %}
              <div class="col-md-6">
                <h6 class="fw-semibold text-danger">üíª C++</h6>
                <pre class="code-box border rounded bg-light p-3">{{ topic.sample_cpp }}</pre>
              </div>
            {% endif %}
            {% if "Python" in topic.lang_support %}
              <div class="col-md-6">
                <h6 class="fw-semibold text-success">üêç Python</h6>
                <pre class="code-box border rounded bg-light p-3">{{ topic.sample_py }}</pre>
              </div>
            {% endif %}
          </div>

          <!-- IDE ch·∫°y code -->
          <form method="post" action="/roadmap/run/" class="mt-3" onsubmit="return runCode(this);">
            {% csrf_token %}
            <div class="mb-2">
              <label class="form-label">Ng√¥n ng·ªØ</label>
              <select name="language" class="form-select form-select-sm">
                <option value="cpp">C++</option>
                <option value="python">Python</option>
                <option value="pypy">PyPy</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">Code c·ªßa b·∫°n</label>
              <textarea name="code" rows="6" class="form-control">{{ topic.sample_cpp }}</textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Input test</label>
              <textarea name="input" rows="3" class="form-control" placeholder="Nh·∫≠p d·ªØ li·ªáu test..."></textarea>
            </div>
            <button type="submit" class="btn btn-success btn-sm">‚ñ∂ Ch·∫°y th·ª≠</button>
          </form>

          <pre class="mt-3 bg-dark text-light p-3 rounded d-none" id="output-box"></pre>
        </div>
      </div>
    {% empty %}
      <p class="text-muted fst-italic">Ch∆∞a c√≥ n·ªôi dung cho giai ƒëo·∫°n n√†y.</p>
    {% endfor %}

    <!-- ========== ƒêI·ªÄU H∆Ø·ªöNG ========== -->
    <div class="d-flex justify-content-between my-4">
      {% if prev_stage %}
        <a href="/roadmap/stage/{{ prev_stage.id }}/" class="btn btn-outline-secondary">‚¨ÖÔ∏è {{ prev_stage.title }}</a>
      {% endif %}
      {% if next_stage %}
        <a href="/roadmap/stage/{{ next_stage.id }}/" class="btn btn-primary">{{ next_stage.title }} ‚û°Ô∏è</a>
      {% endif %}
    </div>
  </main>

  <footer class="text-center mt-5 mb-3 text-muted small">
    ¬© 2025 Chuy√™n Tr·∫ßn Ph√∫ - IT Contest OJ
  </footer>

  <script>
    // AJAX ch·∫°y code
    async function runCode(form) {
      const data = new FormData(form);
      const resp = await fetch(form.action, { method: "POST", body: data });
      const res = await resp.json();
      const box = form.parentElement.querySelector("#output-box");
      box.classList.remove("d-none");
      box.textContent = res.output || ("‚ö†Ô∏è L·ªói: " + (res.error || "Kh√¥ng x√°c ƒë·ªãnh"));
      return false;
    }
  </script>
</body>
</html>
