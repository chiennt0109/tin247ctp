{% extends 'base.html' %}
{% block title %}{{ stage.title }} | CodePath{% endblock %}

{% block extra_head %}
<style>
  body { background-color: #f8fafc; }

  .topic-item {
    cursor: pointer;
    padding: 10px 12px;
    border-left: 4px solid transparent;
    border-radius: 5px;
    transition: 0.25s;
  }
  .topic-item:hover { background-color: #eef6ff; }
  .topic-item.active {
    background-color: #e0f2fe;
    border-left-color: #0d6efd;
  }

  #topic-content {
    opacity: 0;
    transition: opacity 0.4s ease-in-out;
  }
  #topic-content.show { opacity: 1; }

  pre {
    background: #f1f5f9;
    border-left: 4px solid #0d6efd;
    padding: 12px 16px;
    border-radius: 6px;
    font-family: "Fira Code", monospace;
    font-size: 0.9rem;
    overflow-x: auto;
  }

  #output-box {
    min-height: 120px;
    max-height: 400px;
    overflow-y: auto;
  }

  /* N√∫t chuy·ªÉn giai ƒëo·∫°n */
  .stage-nav-btn {
    position: fixed;
    bottom: 40px;
    z-index: 1200;
    padding: 10px 20px;
    border-radius: 40px;
    font-size: 0.95rem;
    font-weight: 500;
    color: white;
    background: #0d6efd;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    text-decoration: none;
    transition: all 0.3s ease;
  }
  .stage-nav-btn:hover { background: #2563eb; transform: scale(1.05); }
  .stage-prev { left: 25px; }
  .stage-next { right: 25px; }
  .stage-nav-btn[data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 115%;
    left: 50%;
    transform: translateX(-50%);
    white-space: nowrap;
    background: rgba(30,41,59,0.9);
    color: #fff;
    font-size: 13px;
    padding: 6px 10px;
    border-radius: 6px;
  }

  @media (max-width: 992px) {
    .stage-nav-btn { display: none; }
  }
</style>
{% endblock %}

{% block content %}
<h4 class="fw-bold text-danger">{{ stage.title }}</h4>
<p class="text-muted mb-4">{{ stage.summary }}</p>

<div class="row">
  <!-- SIDEBAR TR√ÅI -->
  <div class="col-lg-4 border-end">
    <h5 class="fw-semibold text-secondary mb-3">üìò N·ªôi dung</h5>
    <div id="topic-list">
      {% for topic in stage.topics %}
        <div class="topic-item mb-2" data-index="{{ forloop.counter0 }}">
          <div class="fw-semibold text-primary">{{ topic.title }}</div>
          <small class="text-muted">{{ topic.summary|truncatechars:70 }}</small>
        </div>
      {% empty %}
        <p class="text-muted fst-italic">Ch∆∞a c√≥ n·ªôi dung cho giai ƒëo·∫°n n√†y.</p>
      {% endfor %}
    </div>
  </div>

  <!-- N·ªòI DUNG CHI TI·∫æT -->
  <div class="col-lg-8 ps-4">
    <div id="topic-content" class="show">
      <h6 class="fw-bold text-primary">üëà Ch·ªçn m·ªôt m·ª•c ·ªü c·ªôt tr√°i ƒë·ªÉ xem n·ªôi dung chi ti·∫øt.</h6>
    </div>

    <hr class="my-4">

    <!-- KHUNG TH·ª∞C H√ÄNH -->
    <h5 class="fw-bold text-secondary mb-3">üßÆ Th·ª±c h√†nh ‚Äì Vi·∫øt v√† ch·∫°y code</h5>
    <form id="run-form" class="mb-3">
      {% csrf_token %}
      <div class="row mb-2">
        <div class="col-md-4">
          <label class="form-label">Ng√¥n ng·ªØ</label>
          <select id="language" name="language" class="form-select form-select-sm">
            <option value="cpp">C++</option>
            <option value="python">Python</option>
            <option value="pypy">PyPy</option>
          </select>
        </div>
        <div class="col-md-8">
          <label class="form-label">Input (n·∫øu c√≥)</label>
          <textarea id="input-data" name="input" rows="2" class="form-control" placeholder="Nh·∫≠p d·ªØ li·ªáu test..."></textarea>
        </div>
      </div>

      <label class="form-label fw-semibold">üíª Code c·ªßa b·∫°n</label>
      <textarea id="source-code" name="code" rows="10" class="form-control" placeholder="Nh·∫≠p code t·∫°i ƒë√¢y..."></textarea>

      <div class="text-end mt-3">
        <button type="button" id="reset-btn" class="btn btn-outline-secondary btn-sm me-2">‚Ü©Ô∏è Reset v√≠ d·ª•</button>
        <button type="submit" class="btn btn-success btn-lg">‚ñ∂ Ch·∫°y code</button>
      </div>
    </form>

    <div>
      <h6 class="fw-bold text-secondary">üì§ K·∫øt qu·∫£:</h6>
      <pre id="output-box" class="bg-dark text-light p-3 rounded"></pre>
    </div>
  </div>
</div>

<!-- N√öT CHUY·ªÇN GIAI ƒêO·∫†N -->
{% if prev_stage %}
  <a href="/roadmap/stage/{{ prev_stage.id }}/" class="stage-nav-btn stage-prev" data-tooltip="{{ prev_stage.title }}">‚¨ÖÔ∏è Tr∆∞·ªõc</a>
{% endif %}
{% if next_stage %}
  <a href="/roadmap/stage/{{ next_stage.id }}/" class="stage-nav-btn stage-next" data-tooltip="{{ next_stage.title }}">Sau ‚û°Ô∏è</a>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
  const topics = {{ stage.topics|safe }};
  const topicList = document.getElementById("topic-list");
  const topicContent = document.getElementById("topic-content");
  const codeBox = document.getElementById("source-code");
  const resetBtn = document.getElementById("reset-btn");
  const outputBox = document.getElementById("output-box");
  let currentIndex = -1;

  // hi·ªáu ·ª©ng hi·ªÉn th·ªã
  function showContent(html) {
    topicContent.classList.remove("show");
    setTimeout(() => {
      topicContent.innerHTML = html;
      topicContent.classList.add("show");
    }, 200);
  }

  topicList.addEventListener("click", e => {
    const item = e.target.closest(".topic-item");
    if (!item) return;
    topicList.querySelectorAll(".topic-item").forEach(i => i.classList.remove("active"));
    item.classList.add("active");

    currentIndex = parseInt(item.dataset.index);
    const t = topics[currentIndex];
    if (!t) return;

    // t·∫£i n·ªôi dung file HTML (an to√†n, kh√¥ng ph√° DOM)
    fetch("/static/" + t.html_file)
      .then(r => r.text())
      .then(data => showContent(data))
      .catch(() => showContent("<p class='text-danger'>‚ö†Ô∏è Kh√¥ng t·∫£i ƒë∆∞·ª£c n·ªôi dung.</p>"));

    // hi·ªÉn th·ªã v√≠ d·ª• code
    const lang = document.getElementById("language").value;
    codeBox.value = (lang === "cpp") ? t.sample_cpp : t.sample_py;
    outputBox.textContent = "";
  });

  resetBtn.addEventListener("click", () => {
    if (currentIndex >= 0) {
      const t = topics[currentIndex];
      const lang = document.getElementById("language").value;
      codeBox.value = (lang === "cpp") ? t.sample_cpp : t.sample_py;
      outputBox.textContent = "";
    }
  });

  document.getElementById("run-form").addEventListener("submit", async e => {
    e.preventDefault();
    outputBox.textContent = "‚è≥ ƒêang ch·∫°y code...";
    const data = new FormData(e.target);
    try {
      const resp = await fetch("/roadmap/run/", { method: "POST", body: data });
      const res = await resp.json();
      outputBox.textContent = (res.output || res.error || "").trim();
    } catch (err) {
      outputBox.textContent = "‚ùå L·ªói khi g·ª≠i y√™u c·∫ßu: " + err;
    }
  });
</script>
{% endblock %}
