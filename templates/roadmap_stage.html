<!-- path: templates/roadmap_stage.html -->
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>{{ title }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    pre { white-space: pre-wrap; font-size: 0.95rem; }
    .code-sample { font-family: "Fira Code", monospace; }
    .topic-block:hover { background-color: #f8fafc; transition: 0.3s; }
    .section-header { border-left: 5px solid #0d6efd; padding-left: 10px; }
  </style>
</head>

<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/">üè´ IT Contest OJ</a>
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a href="/problems/" class="nav-link">Problems</a></li>
        <li class="nav-item"><a href="/contests/" class="nav-link">Contests</a></li>
      </ul>
    </div>
  </nav>

  <main class="container bg-white shadow-sm p-4 rounded">
    <h2 class="fw-bold text-primary mb-2">{{ title }}</h2>
    <p class="text-muted mb-4">{{ desc }}</p>

    <!-- ========== Ch·ªçn ng√¥n ng·ªØ ========== -->
    <div class="mb-4">
      <span class="me-2 fw-semibold">üí¨ Ch·ªçn ng√¥n ng·ªØ hi·ªÉn th·ªã:</span>
      <button class="btn btn-sm btn-primary" id="btn-cpp">C++</button>
      <button class="btn btn-sm btn-outline-primary" id="btn-py">Python</button>
    </div>

    <!-- ========== PH·∫¶N L√ù THUY·∫æT ========== -->
    <h4 class="section-header mt-5 mb-3">üìò L√Ω thuy·∫øt</h4>
    {% for topic in topics %}
    <div class="card mb-4 topic-block">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <h5 class="fw-bold text-primary">{{ topic.name }}</h5>
          <a href="{{ topic.more_url }}" class="btn btn-link btn-sm text-decoration-none">Chi ti·∫øt ¬ª</a>
        </div>
        <p>{{ topic.summary }}</p>

        <div class="code-sample border rounded p-3 bg-light mb-2" data-lang="cpp">
          <pre><code>{{ topic.cpp_code }}</code></pre>
        </div>
        <div class="code-sample border rounded p-3 bg-light mb-2 d-none" data-lang="py">
          <pre><code>{{ topic.py_code }}</code></pre>
        </div>
      </div>
    </div>
    {% empty %}
    <p class="text-muted fst-italic">Ch∆∞a c√≥ n·ªôi dung cho giai ƒëo·∫°n n√†y.</p>
    {% endfor %}

    <!-- ========== PH·∫¶N TH·ª∞C H√ÄNH ========== -->
    <h4 class="section-header mt-5 mb-3">üßÆ Th·ª±c h√†nh</h4>
    {% for task in practice_tasks %}
    <div class="card mb-4">
      <div class="card-header fw-semibold">{{ task.title }}</div>
      <div class="card-body">
        <p>{{ task.desc }}</p>

        <div><b>V√≠ d·ª• input:</b>
          <pre class="bg-light p-2 border rounded">{{ task.ex_input }}</pre>
        </div>
        <div><b>V√≠ d·ª• output mong ƒë·ª£i:</b>
          <pre class="bg-light p-2 border rounded">{{ task.ex_output }}</pre>
        </div>

        <div class="code-sample border rounded p-3 bg-light mb-2" data-lang="cpp">
          <pre><code>{{ task.cpp_solution }}</code></pre>
        </div>
        <div class="code-sample border rounded p-3 bg-light mb-2 d-none" data-lang="py">
          <pre><code>{{ task.py_solution }}</code></pre>
        </div>

        <!-- Form ch·∫°y code -->
        <form method="post" action="/roadmap/run/" class="mt-3" onsubmit="return runCode(this);">
          {% csrf_token %}
          <div class="mb-2">
            <label class="form-label">Ng√¥n ng·ªØ</label>
            <select name="language" class="form-select form-select-sm" required>
              <option value="cpp">C++</option>
              <option value="python">Python</option>
              <option value="pypy">PyPy</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">Code c·ªßa b·∫°n</label>
            <textarea name="source" rows="6" class="form-control" placeholder="Nh·∫≠p code c·ªßa b·∫°n..."></textarea>
          </div>
          <div class="mb-2">
            <label class="form-label">Input test</label>
            <textarea name="stdin" rows="3" class="form-control">{{ task.ex_input }}</textarea>
          </div>
          <button type="submit" class="btn btn-success btn-sm">‚ñ∂ Ch·∫°y th·ª≠</button>
        </form>

        <div class="mt-3">
          <pre id="output-box" class="bg-dark text-light p-3 rounded d-none"></pre>
        </div>
      </div>
    </div>
    {% empty %}
    <p class="text-muted fst-italic">Ch∆∞a c√≥ b√†i th·ª±c h√†nh cho giai ƒëo·∫°n n√†y.</p>
    {% endfor %}

    <!-- ========== PH·∫¶N LUY·ªÜN T·∫¨P ========== -->
    <h4 class="section-header mt-5 mb-3">üèãÔ∏è Luy·ªán t·∫≠p</h4>
    <p>H√£y th·ª≠ s·ª©c v·ªõi c√°c b√†i t·∫≠p th·ª±c t·∫ø trong h·ªá th·ªëng!</p>
    <a href="/problems/tag/{{ tag }}/" class="btn btn-outline-primary">üß© Xem danh s√°ch b√†i luy·ªán t·∫≠p</a>

    <!-- ========== N√∫t ƒëi·ªÅu h∆∞·ªõng giai ƒëo·∫°n ========== -->
    <div class="d-flex justify-content-between my-5">
      {% if prev_id %}
        <a class="btn btn-outline-secondary" href="/roadmap/stage/{{ prev_id }}/">‚¨ÖÔ∏è Giai ƒëo·∫°n tr∆∞·ªõc</a>
      {% else %}
        <span></span>
      {% endif %}
      {% if next_id %}
        <a class="btn btn-primary" href="/roadmap/stage/{{ next_id }}/">Giai ƒëo·∫°n ti·∫øp theo ‚û°Ô∏è</a>
      {% endif %}
    </div>
  </main>

  <footer class="text-center mt-5 mb-3 text-muted small">
    ¬© 2025 Chuy√™n Tr·∫ßn Ph√∫ - IT Contest OJ
  </footer>

  <script>
    // Chuy·ªÉn ng√¥n ng·ªØ hi·ªÉn th·ªã
    const btnCpp = document.getElementById("btn-cpp");
    const btnPy = document.getElementById("btn-py");
    function showLang(lang) {
      document.querySelectorAll(".code-sample").forEach(block => {
        if (block.getAttribute("data-lang") === lang) block.classList.remove("d-none");
        else block.classList.add("d-none");
      });
      if (lang === "cpp") {
        btnCpp.classList.replace("btn-outline-primary", "btn-primary");
        btnPy.classList.replace("btn-primary", "btn-outline-primary");
      } else {
        btnPy.classList.replace("btn-outline-primary", "btn-primary");
        btnCpp.classList.replace("btn-primary", "btn-outline-primary");
      }
    }
    btnCpp.addEventListener("click", () => showLang("cpp"));
    btnPy.addEventListener("click", () => showLang("py"));
    showLang("cpp");

    // G·ª≠i code ch·∫°y th·ª≠ m√† kh√¥ng reload trang
    async function runCode(form) {
      const data = new FormData(form);
      const resp = await fetch(form.action, { method: "POST", body: data });
      const res = await resp.json();
      const box = form.parentElement.querySelector("#output-box");
      if (res.output) {
        box.classList.remove("d-none");
        box.textContent = res.output;
      } else {
        box.classList.remove("d-none");
        box.textContent = "‚ö†Ô∏è L·ªói: " + (res.error || "Kh√¥ng x√°c ƒë·ªãnh");
      }
      return false;
    }
  </script>
</body>
</html>
