{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
      <div class="card border-0 shadow-sm rounded-4 p-4">
        <h4 class="fw-semibold text-center mb-3" style="font-weight:500;">üîí ƒê·ªïi m·∫≠t kh·∫©u</h4>
        <p class="text-muted text-center mb-4" style="font-size:0.9rem;">
          ƒê·ªÉ b·∫£o v·ªá t√†i kho·∫£n, b·∫°n n√™n thay m·∫≠t kh·∫©u ƒë·ªãnh k·ª≥.  
          H·ªá th·ªëng h·ªó tr·ª£ hi·ªÉn th·ªã m·∫≠t kh·∫©u üëÅ v√† ƒë√°nh gi√° ƒë·ªô m·∫°nh.
        </p>

        {% if messages %}
          {% for message in messages %}
            <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} rounded-3 py-2 small mb-3">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}

        <form method="post" novalidate id="passwordForm">
          {% csrf_token %}
          {% for field in form %}
            <div class="mb-3 position-relative">
              <label class="form-label text-muted small mb-1" style="font-weight:500;">{{ field.label }}</label>
              <div class="position-relative">
                {{ field }}
                {% if "password" in field.name %}
                  <span class="toggle-pass" data-target="{{ field.id_for_label }}">üëÅ</span>
                {% endif %}
              </div>
              {% if field.errors %}
                <div class="text-danger small mt-1">{{ field.errors|striptags }}</div>
              {% endif %}
            </div>
          {% endfor %}

          <!-- Strength meter -->
          <div id="strengthMeter" class="mt-2 mb-3 d-none">
            <div class="progress" style="height:5px;">
              <div id="strengthBar" class="progress-bar" role="progressbar" style="width:0%;"></div>
            </div>
            <small id="strengthText" class="text-muted small"></small>
          </div>

          <div class="d-grid mt-4">
            <button type="submit" class="btn btn-primary rounded-pill py-2 fw-semibold shadow-sm">
              üíæ L∆∞u thay ƒë·ªïi
            </button>
          </div>
        </form>

        <div class="text-center mt-4">
          <a href="/problems/profile/" class="text-decoration-none small text-muted">
            ‚Üê Quay l·∫°i trang h·ªì s∆°
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  input {
    border-radius: 12px !important;
    border: 1px solid #d9dee3;
    padding: 10px 36px 10px 12px;
    width: 100%;
    font-size: 0.9rem;
    font-weight: 400;
    color: #212529;
  }
  input:focus {
    border-color: #007bff;
    box-shadow: 0 0 4px rgba(0, 123, 255, 0.15);
  }

  label {
    font-weight: 500;
    color: #6c757d;
  }

  .toggle-pass {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    font-size: 1rem;
    color: #adb5bd;
    transition: color 0.2s;
  }

  .toggle-pass:hover {
    color: #007bff;
  }

  .alert-success {
    background-color: #e8f9ef;
    border-color: #b7e4c7;
    color: #2d6a4f;
  }

  .alert-error, .alert-danger {
    background-color: #fdecef;
    border-color: #f5c2c7;
    color: #a4161a;
  }

  .card {
    border-radius: 1rem !important;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // üëÅ Toggle password visibility inline
  document.querySelectorAll(".toggle-pass").forEach(icon => {
    icon.addEventListener("click", () => {
      const target = document.getElementById(icon.dataset.target);
      if (target) {
        const isHidden = target.type === "password";
        target.type = isHidden ? "text" : "password";
        icon.textContent = isHidden ? "üôà" : "üëÅ";
      }
    });
  });

  // üßÆ Password strength meter (new password only)
  const newPass = document.getElementById("id_new_password1");
  if (newPass) {
    const meter = document.getElementById("strengthMeter");
    const bar = document.getElementById("strengthBar");
    const text = document.getElementById("strengthText");

    newPass.addEventListener("input", () => {
      const val = newPass.value.trim();
      if (!val) {
        meter.classList.add("d-none");
        return;
      }
      meter.classList.remove("d-none");
      let score = 0;
      if (val.length >= 8) score += 25;
      if (/[A-Z]/.test(val)) score += 25;
      if (/[0-9]/.test(val)) score += 25;
      if (/[^A-Za-z0-9]/.test(val)) score += 25;

      bar.style.width = score + "%";
      if (score < 50) {
        bar.className = "progress-bar bg-danger";
        text.textContent = "Y·∫øu ‚Äì h√£y th√™m k√Ω t·ª± ƒë·∫∑c bi·ªát v√† s·ªë.";
      } else if (score < 75) {
        bar.className = "progress-bar bg-warning";
        text.textContent = "Trung b√¨nh ‚Äì th√™m ch·ªØ hoa v√† k√Ω t·ª± ƒë·∫∑c bi·ªát.";
      } else {
        bar.className = "progress-bar bg-success";
        text.textContent = "M·∫°nh ‚Äì m·∫≠t kh·∫©u t·ªët!";
      }
    });
  }
});
</script>
{% endblock %}
