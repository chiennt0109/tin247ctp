{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
      <div class="card border-0 shadow-lg rounded-4 p-4">
        <h4 class="fw-bold text-center mb-3">üîí ƒê·ªïi m·∫≠t kh·∫©u</h4>
        <p class="text-muted text-center mb-4">
          V√¨ an to√†n t√†i kho·∫£n, b·∫°n n√™n thay m·∫≠t kh·∫©u ƒë·ªãnh k·ª≥. <br>
          H·ªá th·ªëng s·∫Ω gi√∫p b·∫°n ki·ªÉm tra ƒë·ªô m·∫°nh v√† hi·ªÉn th·ªã m·∫≠t kh·∫©u d·ªÖ d√†ng h∆°n üëÅ.
        </p>

        {% if messages %}
          {% for message in messages %}
            <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} rounded-3 py-2">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}

        <form method="post" novalidate id="passwordForm">
          {% csrf_token %}
          {% for field in form %}
            <div class="mb-3 position-relative">
              <label class="form-label fw-semibold">{{ field.label }}</label>
              <div class="input-group">
                {{ field }}
                {% if "password" in field.name %}
                  <button type="button" class="btn btn-outline-secondary toggle-pass" tabindex="-1">üëÅ</button>
                {% endif %}
              </div>
              {% if field.errors %}
                <div class="text-danger small mt-1">{{ field.errors|striptags }}</div>
              {% endif %}
            </div>
          {% endfor %}

          <!-- Strength meter -->
          <div id="strengthMeter" class="mt-2 mb-3 d-none">
            <div class="progress" style="height:6px;">
              <div id="strengthBar" class="progress-bar" role="progressbar" style="width:0%;"></div>
            </div>
            <small id="strengthText" class="text-muted"></small>
          </div>

          <div class="d-grid mt-4">
            <button type="submit" class="btn btn-primary rounded-pill py-2 fw-semibold shadow-sm">
              üíæ L∆∞u thay ƒë·ªïi
            </button>
          </div>
        </form>

        <div class="text-center mt-4">
          <a href="{% url 'profile' %}" class="text-decoration-none small text-muted">
            ‚Üê Quay l·∫°i trang h·ªì s∆°
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  input {
    border-radius: 10px !important;
    border: 1px solid #dee2e6;
    padding: 10px 12px;
    width: 100%;
  }
  input:focus {
    border-color: #007bff;
    box-shadow: 0 0 4px rgba(0,123,255,0.25);
  }
  .alert-success {
    background-color: #e7f6ee;
    border-color: #b7e4c7;
    color: #2d6a4f;
  }
  .alert-error, .alert-danger {
    background-color: #fde2e4;
    border-color: #f5c2c7;
    color: #a4161a;
  }
  .toggle-pass {
    border-radius: 0 10px 10px 0 !important;
    border-color: #dee2e6;
    background-color: #fff;
  }
  .toggle-pass:hover {
    background-color: #f1f3f5;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Toggle password visibility
  document.querySelectorAll(".toggle-pass").forEach(btn => {
    btn.addEventListener("click", () => {
      const input = btn.parentElement.querySelector("input");
      input.type = input.type === "password" ? "text" : "password";
      btn.textContent = input.type === "password" ? "üëÅ" : "üôà";
    });
  });

  // Password strength meter (for new password)
  const newPass = document.getElementById("id_new_password1");
  if (newPass) {
    const meter = document.getElementById("strengthMeter");
    const bar = document.getElementById("strengthBar");
    const text = document.getElementById("strengthText");

    newPass.addEventListener("input", () => {
      const value = newPass.value.trim();
      meter.classList.remove("d-none");
      let score = 0;
      if (value.length >= 8) score += 25;
      if (/[A-Z]/.test(value)) score += 25;
      if (/[0-9]/.test(value)) score += 25;
      if (/[^A-Za-z0-9]/.test(value)) score += 25;

      bar.style.width = score + "%";
      if (score < 50) {
        bar.className = "progress-bar bg-danger";
        text.textContent = "Y·∫øu ‚Äì h√£y th√™m k√Ω t·ª± ƒë·∫∑c bi·ªát v√† s·ªë.";
      } else if (score < 75) {
        bar.className = "progress-bar bg-warning";
        text.textContent = "Trung b√¨nh ‚Äì th√™m ch·ªØ hoa v√† k√Ω t·ª± ƒë·∫∑c bi·ªát.";
      } else {
        bar.className = "progress-bar bg-success";
        text.textContent = "M·∫°nh ‚Äì m·∫≠t kh·∫©u t·ªët!";
      }
    });
  }
});
</script>
{% endblock %}
