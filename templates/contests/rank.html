{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="fw-bold mb-0">üèÖ B·∫£ng x·∫øp h·∫°ng ‚Äì {{ contest.name }}</h3>
    <a href="{% url 'contest_detail' contest.id %}" class="btn btn-outline-secondary rounded-pill">
      ‚Üê Quay l·∫°i contest
    </a>
  </div>

  {% if rankings %}
  <div class="card border-0 shadow-sm rounded-4">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:60px;">#</th>
            <th>Ng∆∞·ªùi tham gia</th>
            <th class="text-center">AC/T·ªïng</th>
            <th class="text-center">ƒêi·ªÉm</th>
            <th class="text-center">Penalty</th>
            <th class="text-center">L·∫ßn n·ªôp cu·ªëi</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rankings %}
            {% if forloop.counter == 1 %}
              {% set_color = "gold" %}
            {% elif forloop.counter == 2 %}
              {% set_color = "silver" %}
            {% elif forloop.counter == 3 %}
              {% set_color = "#cd7f32" %}
            {% endif %}
            <tr style="background-color:{% if forloop.counter <= 3 %}rgba(255,223,0,0.1){% endif %};">
              <td class="fw-bold" style="
                {% if forloop.counter == 1 %}color:gold;
                {% elif forloop.counter == 2 %}color:silver;
                {% elif forloop.counter == 3 %}color:#cd7f32;
                {% endif %}
              ">
                {% if forloop.counter == 1 %}ü•á{% elif forloop.counter == 2 %}ü•à{% elif forloop.counter == 3 %}ü•â{% endif %}
                {{ forloop.counter }}
              </td>
              <td class="fw-semibold">{{ r.user.username }}</td>
              <td class="text-center text-success fw-semibold">
                {{ r.score|divisibleby:100 }}/{{ total_problems }}
              </td>
              <td class="text-center fw-bold text-primary">{{ r.score }}</td>
              <td class="text-center text-muted">{{ r.penalty }}</td>
              <td class="text-center">{{ r.last_submit|date:"d/m/Y H:i" }}</td>
            </tr>
          {% endfor %}

        </tbody>
      </table>

      <div class="text-center mt-4">
        <button id="aiReportBtn" class="btn btn-outline-info rounded-pill">
          ü§ñ Xem ph√¢n t√≠ch AI c√° nh√¢n
        </button>
        <pre id="aiReportOutput" class="mt-3 p-3 bg-light rounded" style="display:none;"></pre>
        </div>
        
        <script>
        document.getElementById("aiReportBtn").addEventListener("click", async () => {
          const res = await fetch(window.location.pathname + "ai_report/");
          const data = await res.json();
          const pre = document.getElementById("aiReportOutput");
          pre.style.display = "block";
          pre.innerHTML =
            "üìä " + data.summary + "\n" +
            "‚ùå S·ªë l·∫ßn n·ªôp sai: " + data.wrong_subs + "\n\n" +
            "üéØ G·ª£i √Ω h·ªçc t·∫≠p ti·∫øp theo:\n" +
            data.ai_path.map((s, i) => `${i+1}. ${s}`).join("\n");
        });
        </script>

      </div>
  </div>
  {% else %}
    <p class="text-muted text-center py-4">‚ùó Ch∆∞a c√≥ ai tham gia cu·ªôc thi n√†y.</p>
  {% endif %}
</div>

<style>
.table-hover tbody tr:hover { background-color:#f8fafc !important; }
.table th, .table td { vertical-align: middle; }
</style>
{% endblock %}
