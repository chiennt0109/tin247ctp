{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">

  <a href="{% url 'problem_list' %}" class="btn btn-outline-secondary mb-3">⬅ Quay lại danh sách</a>

  <div class="d-flex justify-content-between align-items-center mb-2">
    <h3 class="fw-bold">{{ problem.code }} — {{ problem.title }}</h3>
    <a href="{% url 'submission_create' problem.id %}" class="btn btn-success">🚀 Gửi bài</a>
  </div>

  <p class="mb-1">
    <b>Độ khó:</b>
    {% if problem.difficulty == "Easy" %} <span class="badge rounded-pill text-bg-success">Easy</span>
    {% elif problem.difficulty == "Medium" %} <span class="badge rounded-pill text-bg-warning">Medium</span>
    {% else %} <span class="badge rounded-pill text-bg-danger">Hard</span>
    {% endif %}
  </p>
  <p class="text-muted"><b>Đã AC:</b> {{ ac_count }} / {{ submit_count }} lượt</p>

  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
      <!--  🔧 KHÔNG dùng <pre> để MathJax xử lý LaTeX; vẫn giữ xuống dòng bằng CSS -->
      <div class="problem-statement">
        {{ problem.statement|linebreaksbr|safe }}
      </div>
    </div>
  </div>

  <h5 class="fw-semibold mb-2">🤖 Hỗ trợ AI</h5>
  <div class="d-flex gap-2 flex-wrap mb-2">
    <button onclick="aiHint()" class="btn btn-warning">💡 Gợi ý</button>
    <button onclick="aiRecommend()" class="btn btn-info text-white">📌 Gợi ý bài kế</button>
    <button onclick="aiPath()" class="btn btn-primary">📚 Lộ trình học</button>
  </div>
  <div id="aiBox" class="alert alert-secondary d-none"></div>

</div>

<style>
.problem-statement{
  white-space: pre-wrap; 
  line-height: 1.6;
  font-size: 1.02rem;
}
</style>

<!-- ⚙️ MathJax v3 cấu hình để nhận $...$ và \( ... \) -->
<script>
window.MathJax = {
  tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$','$$'], ['\\[','\\]']] },
  svg: { fontCache: 'global' }
};
</script>
<script id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<script>
function show(text) {
  const box = document.getElementById("aiBox");
  box.classList.remove("d-none");
  box.innerHTML = text;
}

function aiHint() {
  fetch(`/problems/{{ problem.id }}/ai_hint_real/`)
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(d => show("💡 " + (d.result || d.hint || "Không có dữ liệu")))
    .catch(() => show("⚠️ Không gọi được gợi ý."));
}

function aiRecommend() {
  fetch(`/problems/{{ problem.id }}/ai_recommend/`)
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(d => show("➡️ " + (d.result || "Không có dữ liệu")))
    .catch(() => show("⚠️ Không gọi được gợi ý tiếp theo."));
}

function aiPath() {
  fetch(`/problems/ai_learning_path/`)
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(d => show("📚 " + (d.summary ? d.summary : JSON.stringify(d))))
    .catch(() => show("⚠️ Không gọi được lộ trình học."));
}
</script>
{% endblock %}
