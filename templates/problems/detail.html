{% extends 'base.html' %}
{% load static %}
{% block content %}

<style>
.problem-wrap{
  display:flex;justify-content:center;align-items:flex-start;
  gap:24px;margin:20px auto;max-width:1280px;padding:0 16px;
}

/* Paper */
.problem-paper{
  flex:1 1 880px;background:#fff;border-radius:14px;
  box-shadow:0 4px 16px rgba(0,0,0,.06);border:1px solid #e5e7eb;
  padding:24px 26px;
}
.problem-title{font-size:26px;font-weight:800;color:#0f172a;margin-bottom:4px}
.markdown-body{line-height:1.65;font-size:16px;color:#111827}
.markdown-body pre code{display:block;padding:10px;border-radius:10px;overflow:auto;background:#f6f8fa}
.badge-soft{border-radius:999px;padding:.25rem .6rem;font-weight:600;font-size:.82rem}
.badge-easy{background:#ecfdf5;color:#064e3b}
.badge-info{background:#eff6ff;color:#1d4ed8}
.alert-soft{background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:14px;display:none}

/* === Buttons cá»™t pháº£i === */
.toolbar-side{
  flex:0 0 180px;
  position:sticky;
  top:82px; /* canh Ä‘Ãºng vá»›i navbar fixed 64px + margin nhá» */
  display:flex;flex-direction:column;gap:10px;
  align-items:flex-end; /* cÄƒn mÃ©p pháº£i */
  margin-right:8px; /* canh tháº³ng nÃºt há»c táº­p */
}
.toolbar-btn{
  display:flex;align-items:center;justify-content:flex-start;
  gap:8px;padding:8px 14px;border-radius:8px;font-weight:600;
  font-size:14px;border:none;color:#fff;cursor:pointer;
  min-width:180px;transition:all .15s ease;
  box-shadow:0 2px 6px rgba(0,0,0,0.12);
}
.toolbar-btn:hover{transform:translateY(-1px)}
.btn-back{background:#6b7280}
.btn-submit{background:#16a34a}
.btn-ai{background:#2563eb}
.btn-next{background:#0ea5e9}
.btn-copy{background:#374151}

/* === Mobile: Ä‘áº·t gÃ³c trÃªn pháº£i === */
#ai-fab{
  display:none;position:fixed;top:72px;right:18px;
  width:44px;height:44px;border-radius:50%;
  border:none;background:#2563eb;color:#fff;
  font-size:20px;box-shadow:0 4px 12px rgba(0,0,0,.25);
  z-index:9999;
}
#ai-menu{
  display:none;position:fixed;top:126px;right:16px;background:#fff;
  border:1px solid #ddd;border-radius:10px;box-shadow:0 6px 16px rgba(0,0,0,.15);
  padding:8px;z-index:9999;
}
#ai-menu button,#ai-menu a{
  display:block;width:180px;margin:4px 0;text-align:left;
  border:none;border-radius:6px;padding:7px 10px;font-weight:600;
  color:#fff;font-size:14px;
}
#ai-menu .btn-back{background:#6b7280}
#ai-menu .btn-submit{background:#16a34a}
#ai-menu .btn-ai{background:#2563eb}
#ai-menu .btn-next{background:#0ea5e9}
#ai-menu .btn-copy{background:#374151}

@media(max-width:992px){
  .toolbar-side{display:none}
  #ai-fab{display:block}
}
</style>

<div class="problem-wrap">
  <div class="problem-paper">
    <div class="problem-title">{{ problem.title }}</div>
    <div class="text-muted mb-2">{{ problem.code }}</div>

    {% if problem.difficulty %}
      <span class="badge-soft badge-easy">ğŸŸ¢ {{ problem.difficulty }}</span>
    {% endif %}
    {% for t in problem.tags.all %}
      <span class="badge-soft badge-info">#{{ t.name }}</span>
    {% endfor %}

    <hr class="my-3">
    <textarea id="md-src" hidden>{{ problem.statement }}</textarea>
    <div id="problem-statement" class="markdown-body"></div>

    <hr class="my-3">
    <div class="text-success fw-semibold">
      âœ… ÄÃ£ AC: {{ ac_count }} / {{ submit_count }} submissions
    </div>
    <div id="aiBox" class="alert-soft"></div>
  </div>

  <div class="toolbar-side">
    {% if contest_id %}
      <a href="{% url 'contests:contest_detail' contest_id %}" class="toolbar-btn btn-back">â¬… Contest</a>
    {% else %}
      <a href="{% url 'problems:problem_list' %}" class="toolbar-btn btn-back">â¬… Problems</a>
    {% endif %}
    <a href="{% url 'submission_create' problem.id %}{% if contest_id %}?contest_id={{ contest_id }}{% endif %}" class="toolbar-btn btn-submit">ğŸš€ Ná»™p bÃ i</a>
    <button id="btn-ai-hint" class="toolbar-btn btn-ai">ğŸ’¡ Gá»£i Ã½ AI</button>
    <button id="btn-ai-next" class="toolbar-btn btn-next">ğŸ“Œ BÃ i káº¿</button>
    <button id="btn-ai-copy" class="toolbar-btn btn-copy">ğŸ“‹ Copy Ä‘á»</button>
  </div>
</div>

<!-- Floating menu for mobile -->
<button id="ai-fab">âš™ï¸</button>
<div id="ai-menu">
  {% if contest_id %}
    <a href="{% url 'contests:contest_detail' contest_id %}" class="btn-back">â¬… Contest</a>
  {% else %}
    <a href="{% url 'problems:problem_list' %}" class="btn-back">â¬… Problems</a>
  {% endif %}
  <a href="{% url 'submission_create' problem.id %}{% if contest_id %}?contest_id={{ contest_id }}{% endif %}" class="btn-submit">ğŸš€ Ná»™p bÃ i</a>
  <button id="btn-ai-hint-m" class="btn-ai">ğŸ’¡ Gá»£i Ã½</button>
  <button id="btn-ai-next-m" class="btn-next">ğŸ“Œ BÃ i káº¿</button>
  <button id="btn-ai-copy-m" class="btn-copy">ğŸ“‹ Copy</button>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<script>
(function(){
  const src=document.getElementById('md-src');
  const out=document.getElementById('problem-statement');
  marked.setOptions({
    breaks:true,gfm:true,
    highlight:(code,lang)=>{try{return hljs.highlight(code,{language:lang||'plaintext'}).value}catch{return code}}
  });
  const html=marked.parse(src.value||'');
  out.innerHTML=DOMPurify.sanitize(html,{USE_PROFILES:{html:true}});
  if(window.renderMathInElement){
    renderMathInElement(out,{delimiters:[{left:"$$",right:"$$",display:true},{left:"$",right:"$",display:false}],throwOnError:false});
  }
  out.querySelectorAll('pre code').forEach(el=>hljs.highlightElement(el));
})();
function showAI(text,type='info'){
  const box=document.getElementById('aiBox');
  box.style.display='block';
  box.innerHTML=(type==='error'?'âš ï¸ ':'ğŸ¤– ')+text;
}
async function callAI(api){
  try{
    const res=await fetch(api);
    if(!res.ok)throw new Error(await res.text());
    const data=await res.json();
    showAI(data.hint||data.result||'KhÃ´ng cÃ³ gá»£i Ã½.');
  }catch(e){showAI('KhÃ´ng gá»i Ä‘Æ°á»£c gá»£i Ã½ AI.','error');}
}
async function copyText(){
  const txt=document.getElementById('problem-statement').innerText;
  try{await navigator.clipboard.writeText(txt);showAI('âœ… ÄÃ£ copy Ä‘á»');}
  catch{showAI('KhÃ´ng copy Ä‘Æ°á»£c.','error');}
}
document.getElementById('btn-ai-hint').onclick=()=>callAI("{% url 'ai_hint' problem.id %}");
document.getElementById('btn-ai-next').onclick=()=>callAI("{% url 'ai_recommend' problem.id %}");
document.getElementById('btn-ai-copy').onclick=copyText;
document.getElementById('btn-ai-hint-m').onclick=()=>callAI("{% url 'ai_hint' problem.id %}");
document.getElementById('btn-ai-next-m').onclick=()=>callAI("{% url 'ai_recommend' problem.id %}");
document.getElementById('btn-ai-copy-m').onclick=copyText;
document.getElementById('ai-fab').addEventListener('click',()=>{
  const m=document.getElementById('ai-menu');
  m.style.display=(m.style.display==='block'?'none':'block');
});
</script>
{% endblock %}
