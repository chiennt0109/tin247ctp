{% extends 'base.html' %}
{% load static %}
{% block content %}

<style>
/* khung ‚Äúgi·∫•y‚Äù ƒë·ªçc nh∆∞ PDF */
.problem-page { max-width: 980px; margin: 0 auto; }
.btn-top-actions { display:flex; gap:.6rem; margin-bottom: .75rem; }
.problem-paper{
  background:#fff;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.06);
  padding:24px 22px;border:1px solid #eef2f7
}
.problem-title{font-size:28px;font-weight:800;color:#0f172a;margin-bottom:4px}
.markdown-body{line-height:1.65;color:#111827;font-size:16px}
.markdown-body h1,.markdown-body h2,.markdown-body h3{margin-top:1.15em;font-weight:700}
.markdown-body code{background:#f6f8fa;padding:.15rem .35rem;border-radius:6px}
.markdown-body pre code{display:block;padding:12px;border-radius:10px;overflow:auto}
.markdown-body table{border-collapse:collapse;margin:10px 0;width:100%}
.markdown-body th,.markdown-body td{border:1px solid #e5e7eb;padding:6px 10px}
.katex-display{margin:1rem 0;text-align:center}
.ai-actions{display:flex;flex-wrap:wrap;gap:.6rem;margin-top:14px}
.badge-soft{border-radius:999px;padding:.25rem .6rem;font-weight:600;font-size:.82rem}
.badge-easy{background:#ecfdf5;color:#064e3b}
.badge-info{background:#eff6ff;color:#1d4ed8}
.alert-soft{background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px;margin-top:10px;display:none}
</style>

<div class="problem-page">

  <!-- ‚úÖ Top buttons (ngo√†i ‚Äúgi·∫•y‚Äù) -->
  <div class="btn-top-actions">
    <a href="{% url 'problem_list' %}" class="btn btn-outline-secondary rounded-pill">‚¨Ö Quay l·∫°i</a>
    <a href="{% url 'submission_create' problem.id %}" class="btn btn-success rounded-pill">üöÄ N·ªôp b√†i</a>
  </div>

  <!-- ‚úÖ ‚ÄúGi·∫•y‚Äù ƒë·ªçc ƒë·ªÅ -->
  <div class="problem-paper">

    <div class="problem-title">{{ problem.title }}</div>
    <div class="text-muted mb-2">{{ problem.code }}</div>

    {% if problem.difficulty %}
      <span class="badge-soft badge-easy">üü¢ {{ problem.difficulty }}</span>
    {% endif %}
    {% for t in problem.tags.all %}
      <span class="badge-soft badge-info">#{{ t.name }}</span>
    {% empty %}{% endfor %}

    <hr class="my-3">

    <!-- üîπ Markdown source (·∫©n) -->
    <textarea id="md-src" hidden>{{ problem.statement }}</textarea>

    <!-- üîπ Rendered HTML -->
    <div id="problem-statement" class="markdown-body"></div>

    <hr class="my-3">

    <div class="text-success fw-semibold">
      ‚úÖ ƒê√£ AC: {{ ac_count }} / {{ submit_count }} submissions
    </div>

    <!-- üîπ K·∫øt qu·∫£ AI -->
    <div id="aiBox" class="alert-soft"></div>

  </div>

  <!-- ‚úÖ AI buttons d∆∞·ªõi ‚Äúgi·∫•y‚Äù -->
  <div class="ai-actions">
    <button id="btn-ai-hint" class="btn btn-primary rounded-pill">üí° G·ª£i √Ω AI</button>
    <button id="btn-ai-next" class="btn btn-info text-white rounded-pill">üìå G·ª£i √Ω b√†i k·∫ø</button>
    <button id="btn-ai-copy" class="btn btn-outline-dark rounded-pill">üìã Copy ƒë·ªÅ</button>
  </div>
</div>

<!-- =========================
     Assets: Marked + DOMPurify + KaTeX + HLJS
========================= -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<script>
(function(){
  const src = document.getElementById('md-src');
  const out = document.getElementById('problem-statement');

  // 1) Markdown -> HTML (kh√¥ng hi·ªÉn th·ªã raw ‚Äú##‚Äù, kh√¥ng coi to√†n b·ªô l√† code)
  marked.setOptions({
    breaks: true,
    gfm: true,
    smartLists: true,
    highlight: (code, lang) => { try { return hljs.highlight(code, {language: lang||'plaintext'}).value } catch { return code } }
  });
  const html = marked.parse(src.value || '');

  // 2) Sanitize ƒë·ªÉ kh√¥ng b·ªã ‚Äúhi·ªán m√£‚Äù/tag l·∫°
  const clean = DOMPurify.sanitize(html, {USE_PROFILES: {html: true}});

  // 3) ƒê·ªï ra DOM
  out.innerHTML = clean;

  // 4) Render KaTeX (h·ªó tr·ª£ $...$, $$...$$, \(..\), \[..\])
  if (window.renderMathInElement) {
    renderMathInElement(out, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$",  right: "$",  display: false },
        { left: "\\(", right: "\\)", display: false },
        { left: "\\[", right: "\\]", display: true }
      ],
      throwOnError: false
    });
  }

  // 5) Re-highlight code blocks sau khi KaTeX xong
  out.querySelectorAll('pre code').forEach(el => { try { hljs.highlightElement(el) } catch(e){} });
})();
</script>

<script>
// Helpers hi·ªÉn th·ªã k·∫øt qu·∫£ AI
function showAI(text, type='info'){
  const box = document.getElementById('aiBox');
  box.style.display = 'block';
  box.className = 'alert-soft';
  box.innerHTML = (type==='error' ? '‚ö†Ô∏è ' : 'ü§ñ ') + text;
}

// üí° G·ª£i √Ω AI (LLM)
document.getElementById('btn-ai-hint').addEventListener('click', async () => {
  try{
    const res = await fetch("{% url 'ai_hint' problem.id %}");
    if(!res.ok){ const t = await res.text(); throw new Error(t||res.statusText); }
    const data = await res.json();
    showAI(data.hint || data.result || 'Kh√¥ng c√≥ g·ª£i √Ω.');
  }catch(e){ showAI('Kh√¥ng g·ªçi ƒë∆∞·ª£c g·ª£i √Ω AI.', 'error'); }
});

// üìå G·ª£i √Ω b√†i k·∫ø ti·∫øp
document.getElementById('btn-ai-next').addEventListener('click', async () => {
  try{
    const res = await fetch("{% url 'ai_recommend' problem.id %}");
    if(!res.ok){ const t = await res.text(); throw new Error(t||res.statusText); }
    const data = await res.json();
    showAI(data.result || 'Kh√¥ng c√≥ ƒë·ªÅ xu·∫•t.');
  }catch(e){ showAI('Kh√¥ng g·ªçi ƒë∆∞·ª£c g·ª£i √Ω b√†i k·∫ø ti·∫øp.', 'error'); }
});

// üìã Copy ƒë·ªÅ
document.getElementById('btn-ai-copy').addEventListener('click', async () => {
  const txt = document.getElementById('problem-statement').innerText;
  try{ await navigator.clipboard.writeText(txt); showAI('ƒê√£ copy n·ªôi dung ƒë·ªÅ ‚úÖ'); }
  catch{ showAI('Kh√¥ng copy ƒë∆∞·ª£c n·ªôi dung.', 'error'); }
});
</script>

{% endblock %}
