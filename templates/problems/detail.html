{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">

    <a href="{% url 'problem_list' %}" class="btn btn-outline-secondary mb-3">⬅ Quay lại danh sách</a>

    <div class="d-flex justify-content-between align-items-center mb-2">
        <h3 class="fw-bold">{{ problem.code }} — {{ problem.title }}</h3>

        <a href="{% url 'submission_create' problem.id %}" class="btn btn-success btn-lg">
            🚀 Nộp bài
        </a>
    </div>

    <p class="mb-1">
        <b>Độ khó:</b>
        {% if problem.difficulty == "Easy" %}
            <span class="badge rounded-pill text-bg-success">Easy</span>
        {% elif problem.difficulty == "Medium" %}
            <span class="badge rounded-pill text-bg-warning">Medium</span>
        {% else %}
            <span class="badge rounded-pill text-bg-danger">Hard</span>
        {% endif %}
    </p>

    <p class="text-muted">
        ✅ <b>{{ ac_count }}</b> / {{ submit_count }} lượt đã AC
    </p>

    <!-- 🔥 Vùng hiển thị đề bài -->
    <div class="card shadow-sm border-0 mb-4 p-3">
        <!-- Markdown source -->
        <textarea id="md-src" hidden>{{ problem.statement }}</textarea>

        <!-- Render output -->
        <div id="problem-statement" class="markdown-body"></div>
    </div>

    <!-- 🤖 AI Support -->
    <h5 class="fw-semibold mb-2">🤖 Hỗ trợ AI</h5>
    <div class="d-flex gap-2 flex-wrap mb-2">
        <button onclick="aiHint()" class="btn btn-warning">💡 Gợi ý</button>
        <button onclick="aiRecommend()" class="btn btn-info text-white">📌 Bài kế tiếp</button>
        <button onclick="aiPath()" class="btn btn-primary">📚 Lộ trình học</button>
    </div>

    <div id="aiBox" class="alert alert-secondary d-none"></div>

</div>

<!-- ✅ Markdown + KaTeX + HighlightJS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const src = document.getElementById("md-src");
    const out = document.getElementById("problem-statement");

    if (!src || !out) return;

    const html = marked.parse(src.value || "");
    out.innerHTML = html;

    if (window.renderMathInElement) {
        renderMathInElement(out, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false }
            ],
            throwOnError: false
        });
    }

    document.querySelectorAll('#problem-statement pre code').forEach(el => {
        try { hljs.highlightElement(el); } catch(e) {}
    });
});

function show(text) {
    const box = document.getElementById("aiBox");
    box.classList.remove("d-none");
    box.innerHTML = text;
}

function aiHint() {
    fetch(`/problems/{{ problem.id }}/ai_hint/`)
        .then(r => r.json())
        .then(d => show("💡 " + (d.hint || d.result || "Không có dữ liệu")));
}

function aiRecommend() {
    fetch(`/problems/{{ problem.id }}/ai_recommend/`)
        .then(r => r.json())
        .then(d => show("➡️ " + (d.result || "Không có dữ liệu")));
}

function aiPath() {
    fetch(`/problems/ai_learning_path/`)
        .then(r => r.json())
        .then(d => show("📚 " + (d.summary || JSON.stringify(d))));
}
</script>

<style>
.markdown-body {
    line-height: 1.6;
    font-size: 16px;
    color: #222;
}
.markdown-body pre code {
    background: #f6f8fa;
    padding: 10px;
    display: block;
    border-radius: 5px;
    overflow-x: auto;
}
.markdown-body .katex-display {
    text-align: center;
    margin: 1rem 0;
}
</style>

{% endblock %}
