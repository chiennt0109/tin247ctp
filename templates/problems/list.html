{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-4">

  <div class="text-center mb-4">
      <h2 class="fw-bold mb-1">üß† Ng√¢n h√†ng B√†i To√°n</h2>
      <p class="text-muted">Kh√°m ph√° ‚Äì Luy·ªán t·∫≠p ‚Äì N√¢ng c·∫•p t∆∞ duy thu·∫≠t to√°n üöÄ</p>
  </div>

  <!-- Filters -->
  <form method="get" class="row gy-2 gx-2 mb-4 align-items-center">
      <div class="col-md-3">
          <input type="text" name="q" value="{{ search_query }}" placeholder="üîç T√¨m theo t√™n ho·∫∑c m√£ b√†i..."
                 class="form-control rounded-pill border-0 shadow-sm px-3">
      </div>

      <div class="col-md-2">
          <select name="tag" class="form-select rounded-pill border-0 shadow-sm px-3">
              <option value="">üè∑ Ch·ªß ƒë·ªÅ</option>
              {% for tag in tags %}
              <option value="{{ tag.slug }}" {% if tag.slug == selected_tag %}selected{% endif %}>{{ tag.name }}</option>
              {% endfor %}
          </select>
      </div>

      <div class="col-md-2">
          <select name="difficulty" class="form-select rounded-pill border-0 shadow-sm px-3">
              <option value="">üéØ ƒê·ªô kh√≥</option>
              {% for d in difficulty_levels %}
              <option value="{{ d }}" {% if d == selected_difficulty %}selected{% endif %}>{{ d }}</option>
              {% endfor %}
          </select>
      </div>

      <div class="col-md-2">
          <select name="sort" class="form-select rounded-pill border-0 shadow-sm px-3">
              <option value="">‚öôÔ∏è S·∫Øp x·∫øp</option>
              <option value="difficulty" {% if sort_by == "difficulty" %}selected{% endif %}>Theo ƒë·ªô kh√≥</option>
              <option value="popularity" {% if sort_by == "popularity" %}selected{% endif %}>Theo ƒë·ªô ph·ªï bi·∫øn</option>
          </select>
      </div>

      <div class="col-md-3 d-flex justify-content-end gap-2">
          <button class="btn btn-primary rounded-pill px-4 shadow-sm">√Åp d·ª•ng</button>
          <a href="/problems/" class="btn btn-outline-secondary rounded-pill px-4 shadow-sm">Reset</a>
      </div>
  </form>

  <!-- Problems List -->
  <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
      <div class="table-responsive">
          <table class="table align-middle mb-0">
              <thead class="table-light">
                  <tr>
                      <th class="small text-secondary">M√£</th>
                      <th class="small text-secondary">T√™n b√†i</th>
                      <th class="small text-secondary">Ch·ªß ƒë·ªÅ</th>
                      <th class="small text-secondary text-center">ƒê·ªô kh√≥</th>
                      <th class="small text-secondary text-center">T·ª∑ l·ªá AC</th>
                      <th class="small text-secondary text-center" style="width:130px;">Thao t√°c</th>
                  </tr>
              </thead>
              <tbody>
              {% for p in problems %}
                  <tr class="hover-row">
                      <td class="fw-semibold text-primary small">
                          <a href="{% url 'problem_detail' p.id %}" class="text-decoration-none">{{ p.code }}</a>
                      </td>

                      <td>
                          <a href="{% url 'problem_detail' p.id %}" class="fw-semibold text-dark text-decoration-none hover-underline">
                              {{ p.title }}
                          </a>
                      </td>

                      <td>
                          {% for t in p.tags.all %}
                            <span class="badge bg-light text-dark border rounded-pill small me-1">{{ t.name }}</span>
                          {% empty %}
                            <span class="text-muted small">‚Äî</span>
                          {% endfor %}
                      </td>

                      <td class="text-center">
                          {% if p.difficulty == "Easy" %}
                            <span class="badge bg-success-subtle text-success rounded-pill">Easy</span>
                          {% elif p.difficulty == "Medium" %}
                            <span class="badge bg-warning-subtle text-dark rounded-pill">Medium</span>
                          {% else %}
                            <span class="badge bg-danger-subtle text-danger rounded-pill">Hard</span>
                          {% endif %}
                      </td>

                      <td class="text-center" style="min-width:150px;">
                          {% if p.submission_count > 0 %}
                            {% widthratio p.ac_count p.submission_count 100 as pct %}
                          {% else %}
                            {% with 0 as pct %}{% endwith %}
                          {% endif %}
                          <div class="small text-muted">{{ p.ac_count }}/{{ p.submission_count }} ‚úÖ ({{ pct }}%)</div>
                          <div class="progress mx-auto" style="height:5px; width:80%;">
                              <div class="progress-bar bg-success" style="width: {{ pct }}%"></div>
                          </div>
                      </td>

                      <td class="text-center">
                          <a href="{% url 'problem_detail' p.id %}" class="btn btn-sm btn-light border rounded-pill">üëÅ</a>
                          <a href="{% url 'submission_create' p.id %}" class="btn btn-sm btn-success rounded-pill ms-1">üöÄ</a>
                      </td>
                  </tr>
              {% empty %}
                <tr><td colspan="6" class="text-center text-muted py-3">Kh√¥ng c√≥ b√†i n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc hi·ªán t·∫°i.</td></tr>
              {% endfor %}
              </tbody>
          </table>
      </div>
  </div>

  <!-- Pagination -->
  {% if problems.paginator.num_pages > 1 %}
  <nav class="mt-4">
    <ul class="pagination justify-content-center">
      {% if problems.has_previous %}
        <li class="page-item">
          <a class="page-link rounded-pill"
             href="?page={{ problems.previous_page_number }}&q={{ search_query }}&tag={{ selected_tag }}&difficulty={{ selected_difficulty }}&sort={{ sort_by }}">
             ‚¨Ö Tr∆∞·ªõc
          </a>
        </li>
      {% endif %}

      {% for i in problems.paginator.page_range %}
        {% if i >= problems.number|add:-2 and i <= problems.number|add:2 %}
          <li class="page-item {% if problems.number == i %}active{% endif %}">
            <a class="page-link rounded-pill"
               href="?page={{ i }}&q={{ search_query }}&tag={{ selected_tag }}&difficulty={{ selected_difficulty }}&sort={{ sort_by }}">
               {{ i }}
            </a>
          </li>
        {% elif i == 1 %}
          <li class="page-item">
            <a class="page-link rounded-pill"
               href="?page=1&q={{ search_query }}&tag={{ selected_tag }}&difficulty={{ selected_difficulty }}&sort={{ sort_by }}">1</a>
          </li>
          {% if problems.number > 3 %}
            <li class="page-item disabled"><span class="page-link border-0">...</span></li>
          {% endif %}
        {% elif i == problems.paginator.num_pages %}
          {% if problems.number < problems.paginator.num_pages|add:-2 %}
            <li class="page-item disabled"><span class="page-link border-0">...</span></li>
          {% endif %}
          <li class="page-item">
            <a class="page-link rounded-pill"
               href="?page={{ problems.paginator.num_pages }}&q={{ search_query }}&tag={{ selected_tag }}&difficulty={{ selected_difficulty }}&sort={{ sort_by }}">
               {{ problems.paginator.num_pages }}
            </a>
          </li>
        {% endif %}
      {% endfor %}

      {% if problems.has_next %}
        <li class="page-item">
          <a class="page-link rounded-pill"
             href="?page={{ problems.next_page_number }}&q={{ search_query }}&tag={{ selected_tag }}&difficulty={{ selected_difficulty }}&sort={{ sort_by }}">
            Sau ‚û°
          </a>
        </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<style>
.table-hover tbody tr:hover, .hover-row:hover { background-color:#f8fafc !important; transition:0.2s; }
.hover-underline:hover { text-decoration: underline!important; }
.card { border-radius: 14px!important; }
.badge.bg-success-subtle { background-color:#e6f4ea!important; }
.badge.bg-warning-subtle { background-color:#fff4e5!important; }
.badge.bg-danger-subtle  { background-color:#fdeaea!important; }
.page-link { border:none!important; color:#333!important; }
.page-item.active .page-link { background-color:#0d6efd!important; color:white!important; }
</style>
{% endblock %}
