{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}

<!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- SimpleMDE Markdown Editor -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>

<!-- AI Editor -->
<script src="{% static 'js/ai_editor.js' %}"></script>

<style>
.container-box{padding:10px 0;}
.ai-buttons button,.zip-btn{margin:4px 0;}
#aiResult{margin-top:6px;font-size:14px;}
.CodeBlock{border:1px solid #ddd;background:#fafafa;padding:8px;white-space:pre-wrap;}
</style>
{% endblock %}

{% block after_related_objects %}
<div class="container-box">

<!-- âœ… AI Auto Fill -->
<h3>ğŸ¤– AI Há»— trá»£ nháº­p liá»‡u</h3>
<button class="button" id="aiAnalyze">âœ¨ PhÃ¢n tÃ­ch & Ä‘iá»n tá»± Ä‘á»™ng</button>
<p id="aiResult"></p>

<hr>

<!-- âœ… AI Latex & Auto Tag Buttons -->
<div class="ai-buttons">
    <button type="button" class="button" onclick="aiGenerateStatement()">ğŸ“ AI táº¡o Ä‘á»</button>
    <button type="button" class="button" onclick="aiFixLatex()">ğŸ§  Sá»­a LaTeX</button>
    <button type="button" class="button" onclick="aiAutoTag()">ğŸ·ï¸ Tá»± gÃ¡n tag</button>
</div>

<hr>

<!-- âœ… Upload ZIP -->
{% if original and original.id %}
<h3>ğŸ“¦ Upload ZIP Test Cases</h3>
<form action="{% url 'admin:problems_problem_upload_tests' original.id %}" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" name="zip_file" accept=".zip" required>
    <button type="submit" class="button zip-btn">â¬†ï¸ Upload ZIP</button>
</form>

<hr>

<!-- âœ… View Tests -->
<h3>ğŸ‘ Test Cases</h3>
<a class="button" target="_blank" href="{% url 'admin:problems_problem_view_tests' original.id %}">ğŸ‘ Xem test</a>
<a class="button" href="{% url 'admin:problems_problem_download_tests' original.id %}">â¬‡ï¸ Táº£i toÃ n bá»™</a>
{% else %}
<p>ğŸ’¡ LÆ°u bÃ i trÆ°á»›c Ä‘á»ƒ upload test hoáº·c xem test.</p>
{% endif %}

</div>

<script>
/* âœ… SimpleMDE init */
document.addEventListener("DOMContentLoaded", function () {
    const textarea = document.querySelector("#id_statement");
    if (textarea) {
        new SimpleMDE({
            element: textarea,
            spellChecker: false,
            autosave: { enabled: true, delay: 1500, uniqueId: "problem_statement" },
            placeholder: "âœï¸ Nháº­p ná»™i dung bÃ i toÃ¡n báº±ng Markdown...",
        });
    }
});

/* âœ… AI Auto-Fill (code + difficulty + tags) */
document.getElementById("aiAnalyze").addEventListener("click", async () => {
  const title = document.querySelector("#id_title").value;
  const statement = document.querySelector("#id_statement").value;

  const res = await fetch("/problems/ai_analyze_problem/", {
    method: "POST",
    headers: {"Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}"},
    body: JSON.stringify({ title, statement })
  });

  const data = await res.json();
  if (data.error) return alert("âŒ " + data.error);

  document.querySelector("#id_code").value = data.code;
  document.querySelector("#id_difficulty").value = data.difficulty;

  let tags = data.tags || [];
  const tagField = document.querySelector("#id_tags");
  for (let option of tagField.options) {
      if (tags.includes(option.text)) option.selected = true;
  }

  document.getElementById("aiResult").innerHTML =
    `âœ… <b>MÃ£:</b> ${data.code} â€” <b>Äá»™ khÃ³:</b> ${data.difficulty} â€” <b>Tags:</b> ${tags.join(", ")}`;
});
</script>
{% endblock %}
