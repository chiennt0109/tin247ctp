{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<div class="container">
  <h2>{{ original.code }} ‚Äì {{ original.title }}</h2>

  <!-- Form ch√≠nh -->
  <form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    {{ adminform.form.as_p }}
    <div class="submit-row">
      <input type="submit" value="üíæ L∆∞u thay ƒë·ªïi" class="default">
    </div>
  </form>

  <!-- N√∫t hi·ªán test -->
  <hr>
  <button id="toggle-tests-btn" class="button">üëÅ Hi·ªán danh s√°ch test case</button>
  <span id="test-status" style="margin-left:10px;color:gray;">‚è≥ Ki·ªÉm tra test...</span>
  <div id="testcase-section" style="display:none;">
    <div id="testcase-content" style="margin-top:10px; text-align:center;">‚è≥ Ch∆∞a t·∫£i test case...</div>
  </div>

  <!-- Upload ZIP -->
  {% if show_upload_button %}
  <hr>
  <h3>üì¶ Upload ZIP Test Cases</h3>
  <form action="{% url 'admin:upload_tests' original.id %}" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" name="zip_file" accept=".zip" required style="margin-bottom:10px;">
    <button type="submit" class="default btn btn-success">‚¨ÜÔ∏è Upload v√† Import</button>
  </form>
  {% endif %}
</div>

<!-- SimpleMDE -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // =========================
  // L·∫•y CSRF token
  // =========================
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // =========================
  // L·∫•y c√°c ph·∫ßn t·ª≠ c·∫ßn thao t√°c
  // =========================
  const btn = document.getElementById("toggle-tests-btn");
  const section = document.getElementById("testcase-section");
  const content = document.getElementById("testcase-content");
  const status = document.getElementById("test-status");
  let visible = false, loaded = false, currentPage = 1;

  // =========================
  // Chu·∫©n h√≥a URL base (c√≥ / ·ªü cu·ªëi)
  // =========================
  let base = window.location.pathname;
  if (!base.endsWith("/")) base += "/";

  // =========================
  // Ki·ªÉm tra nhanh c√≥ test kh√¥ng
  // =========================
  fetch(`${base}has_tests/`, { headers: { "X-CSRFToken": csrftoken } })
    .then(r => r.json())
    .then(d => {
      if (d.count > 0) {
        status.textContent = `‚úÖ ${d.count} test case`;
        status.style.color = "green";
      } else {
        status.textContent = "‚ö†Ô∏è Ch∆∞a c√≥ test case";
        status.style.color = "red";
      }
    })
    .catch(() => {
      status.textContent = "‚ùî Kh√¥ng ki·ªÉm tra ƒë∆∞·ª£c";
      status.style.color = "gray";
    });

  // =========================
  // Toggle hi·ªÉn th·ªã test case
  // =========================
  btn.addEventListener("click", () => {
    visible = !visible;
    section.style.display = visible ? "block" : "none";
    btn.textContent = visible ? "üôà ·∫®n danh s√°ch test case" : "üëÅ Hi·ªán danh s√°ch test case";

    // N·∫øu b·∫≠t l·∫ßn ƒë·∫ßu ‚Üí load lu√¥n test
    if (visible && !loaded) loadPage(currentPage);
  });

  // =========================
  // AJAX t·∫£i test theo trang
  // =========================
  function loadPage(page) {
    content.style.display = "block"; // ƒê·∫£m b·∫£o hi·ªÉn th·ªã
    content.innerHTML = "‚è≥ ƒêang t·∫£i...";
    fetch(`${base}load_tests/?page=${page}`, {
      headers: { "X-CSRFToken": csrftoken }
    })
      .then(res => res.json())
      .then(data => {
        console.log("‚úÖ ƒê√£ t·∫£i test:", data); // DEBUG
        content.innerHTML = data.html; // Hi·ªÉn th·ªã b·∫£ng test
        loaded = true;
        if (data.has_next) {
          const moreBtn = document.getElementById("load-more-tests");
          if (moreBtn) {
            moreBtn.addEventListener("click", () => {
              currentPage = data.next_page;
              moreBtn.disabled = true;
              moreBtn.textContent = "‚è≥ ƒêang t·∫£i...";
              loadPage(currentPage);
              moreBtn.remove();
            });
          }
        }
      })
      .catch(err => {
        console.error("‚ùå L·ªói t·∫£i test:", err);
        content.innerHTML = "<p style='color:red;'>‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i test case.</p>";
      });
  }

  // =========================
  // SimpleMDE Markdown Editor
  // =========================
  const textarea = document.querySelector("#id_statement");
  if (textarea) {
    new SimpleMDE({
      element: textarea,
      spellChecker: false,
      autosave: { enabled: true, delay: 1500, uniqueId: "problem_statement" },
      renderingConfig: { singleLineBreaks: false, codeSyntaxHighlighting: true },
      toolbar: ["bold","italic","heading","|","quote","unordered-list","ordered-list","|",
                "link","image","table","code","|","preview","side-by-side","fullscreen","|","guide"],
      placeholder: "‚úèÔ∏è Nh·∫≠p n·ªôi dung b√†i to√°n b·∫±ng Markdown..."
    });
  }
});
</script>


<style>
.container{max-width:900px;margin:auto;font-family:sans-serif;}
#toggle-tests-btn{background:#3c8dbc;color:white;padding:6px 12px;border:none;border-radius:5px;cursor:pointer;}
#toggle-tests-btn:hover{background:#337ab7;}
#load-more-tests{margin-top:10px;padding:6px 10px;border:1px solid #ccc;border-radius:5px;cursor:pointer;}
#load-more-tests:hover{background:#eee;}
</style>
{% endblock %}
