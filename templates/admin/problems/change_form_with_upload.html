{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<div class="container" style="max-width:1100px;margin:auto;font-family:'Segoe UI',sans-serif;">
  <h2 style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
    âš™ï¸ {{ original.code }} â€“ {{ original.title }}
  </h2>

  <form method="post" enctype="multipart/form-data" id="problemForm">
    {% csrf_token %}
    {{ adminform.form.as_p }}

    <div class="submit-row" style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap;">
      <input type="submit" value="ğŸ’¾ LÆ°u thay Ä‘á»•i" class="default">
      <button type="button" id="ai-analyze-btn"
         style="background:#ff9800;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;">
        âœ¨ PhÃ¢n tÃ­ch AI toÃ n diá»‡n
      </button>
      <button type="button" id="ai-suggest-btn"
         style="background:#17a2b8;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;">
        ğŸ’¡ Gá»£i Ã½ tag
      </button>
    </div>

    <div id="suggestions" style="margin-top:10px;display:none;">
      <p><b>âœ¨ Tag gá»£i Ã½:</b></p>
      <div id="suggested-tags" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
    </div>
  </form>

  <hr style="margin:30px 0;">
  <h3>ğŸ“¦ Upload ZIP Test Cases</h3>
  <form id="uploadForm" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" name="zip_file" accept=".zip" required style="margin-bottom:10px;">
    <button type="submit" class="default"
            style="background:#28a745;color:white;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;">
      ğŸš€ Upload
    </button>
  </form>

  <div id="progressContainer" style="margin-top: 10px; display: none;">
    <label>Äang táº£i lÃªn...</label>
    <div style="width: 100%; background-color: #eee; border-radius: 4px;">
      <div id="progressBar"
           style="width: 0%; height: 20px; background-color: #4caf50;
                  text-align: center; color: white; font-size:12px;">0%</div>
    </div>
  </div>
</div>

<!-- ========== SCRIPT ========== -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const textarea = document.querySelector("#id_statement");
  if (textarea) {
    new SimpleMDE({
      element: textarea,
      spellChecker: false,
      autosave: { enabled: true, delay: 1500, uniqueId: "problem_statement" },
      renderingConfig: { singleLineBreaks: false, codeSyntaxHighlighting: true },
      toolbar: ["bold","italic","heading","|","quote","unordered-list","ordered-list","|",
                "link","image","table","code","|","preview","side-by-side","fullscreen","|","guide"],
      placeholder: "âœï¸ Nháº­p ná»™i dung bÃ i toÃ¡n báº±ng Markdown..."
    });
  }

  const suggestBtn = document.getElementById("ai-suggest-btn");
  const analyzeBtn = document.getElementById("ai-analyze-btn");
  const statement = document.getElementById("id_statement");
  const suggestionsBox = document.getElementById("suggestions");
  const tagArea = document.getElementById("suggested-tags");
  const tagSelect = document.querySelector('select[name="tags"]');

  // ================== Gá»¢I Ã TAG ==================
  suggestBtn.addEventListener("click", async function() {
    suggestBtn.disabled = true;
    suggestBtn.textContent = "â³ Äang gá»£i Ã½...";
    try {
      const res = await fetch("/problems/ai_suggest_tags/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ statement: statement.value })
      });
      const data = await res.json();
      const tags = data.tags || [];
      tagArea.innerHTML = "";
      if (tags.length > 0) {
        suggestionsBox.style.display = "block";
        tags.forEach(tag => {
          const el = document.createElement("span");
          el.textContent = tag;
          el.style = "background:#e0f7fa;color:#00796b;padding:4px 8px;border-radius:6px;cursor:pointer;";
          el.onclick = () => {
            for (const option of tagSelect.options) {
              if (option.text === tag) option.selected = true;
            }
            el.style.background="#b2dfdb";
          };
          tagArea.appendChild(el);
        });
      } else {
        alert("KhÃ´ng gá»£i Ã½ Ä‘Æ°á»£c tag nÃ o.");
      }
    } catch(e) {
      console.error(e);
      alert("âŒ Lá»—i khi gá»£i Ã½ tag.");
    } finally {
      suggestBtn.disabled = false;
      suggestBtn.textContent = "ğŸ’¡ Gá»£i Ã½ tag";
    }
  });

  // ================== PHÃ‚N TÃCH TOÃ€N DIá»†N ==================
  analyzeBtn.addEventListener("click", async function() {
    const title = document.getElementById("id_title").value;
    const codeField = document.getElementById("id_code");
    const diffSelect = document.getElementById("id_difficulty");

    analyzeBtn.disabled = true;
    analyzeBtn.textContent = "â³ Äang phÃ¢n tÃ­ch...";

    try {
      const res = await fetch("/problems/ai_analyze_problem/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ title, statement: statement.value })
      });
      const data = await res.json();

      if (data.code) codeField.value = data.code;
      if (data.difficulty && diffSelect) diffSelect.value = data.difficulty;
      if (data.tags && tagSelect) {
        for (const option of tagSelect.options) {
          option.selected = data.tags.includes(option.text);
        }
      }
      // ğŸŸ¢ LÆ°u tá»± Ä‘á»™ng sau khi AI gá»£i Ã½ xong
      await fetch(window.location.href, {
        method: "POST",
        headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value },
        body: new FormData(document.getElementById("problemForm"))
      });
      
      alert(`âœ… ÄÃ£ cáº­p nháº­t:\nâ€¢ Code: ${data.code}\nâ€¢ Äá»™ khÃ³: ${data.difficulty}\nâ€¢ Tag: ${data.tags.join(", ")}`);
      

  // ================== UPLOAD BAR ==================
  const uploadForm = document.getElementById("uploadForm");
  if (uploadForm) {
    uploadForm.addEventListener("submit", function(e) {
      e.preventDefault();
      const data = new FormData(this);
      const xhr = new XMLHttpRequest();
      const bar = document.getElementById("progressBar");
      const container = document.getElementById("progressContainer");
      xhr.open("POST", "", true);
      xhr.upload.addEventListener("loadstart", () => {
        container.style.display = "block";
        bar.style.width = "0%";
        bar.textContent = "0%";
      });
      xhr.upload.addEventListener("progress", e => {
        if (e.lengthComputable) {
          const percent = Math.round((e.loaded / e.total) * 100);
          bar.style.width = percent + "%";
          bar.textContent = percent + "%";
        }
      });
      xhr.onload = function() {
        if (xhr.status === 200) {
          bar.style.backgroundColor = "#2196F3";
          bar.textContent = "âœ… HoÃ n táº¥t!";
          setTimeout(() => location.reload(), 800);
        } else {
          alert("âŒ Lá»—i khi upload test.");
          bar.style.backgroundColor = "red";
        }
      };
      xhr.send(data);
    });
  }
});
</script>
{% endblock %}
