{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<div class="container">
  <!-- ğŸ§­ ThÃ´ng tin tá»•ng quan bÃ i toÃ¡n -->
  <h2>{{ original.code }} â€“ {{ original.title }}</h2>

  <!-- âœ… Form chá»‰nh sá»­a chÃ­nh -->
  <form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    {{ adminform.form.as_p }}
    <div class="submit-row">
      <input type="submit" value="ğŸ’¾ LÆ°u thay Ä‘á»•i" class="default">
    </div>
  </form>

  <!-- âœ… Gá»£i Ã½ tag báº±ng AI -->
  <div id="ai-suggest" style="margin-top: 15px;">
    <label for="id_tags"><b>ğŸ§  Gá»£i Ã½ Tag AI:</b></label><br>
    <input type="text" id="id_tags" name="tags" value="{{ original.tags }}" style="width: 60%; max-width: 500px;">
    <button id="aiTagBtn" type="button" class="button btn btn-info">âœ¨ Äá» xuáº¥t tá»± Ä‘á»™ng</button>
  </div>

  <hr>
  <!-- âœ… Pháº§n xem test case -->
  <h3>ğŸ‘ Kiá»ƒm tra test case</h3>
  {% if original and original.id %}
    <p>
      <a href="{% url 'admin:view_tests' original.id %}" target="_blank" class="button">
        Má»Ÿ danh sÃ¡ch test trong tab má»›i
      </a>
    </p>
  {% else %}
    <p style="color:gray;">ğŸ’¡ HÃ£y lÆ°u bÃ i toÃ¡n trÆ°á»›c khi xem test case.</p>
  {% endif %}

  {% if show_upload_button %}
  <hr>
  <!-- âœ… Upload test case -->
  <h3>ğŸ“¦ Upload ZIP Test Cases</h3>
  <form id="uploadForm" action="{% url 'admin:upload_tests' original.id %}" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" name="zip_file" accept=".zip" required style="margin-bottom:10px;">
    <button type="submit" class="default btn btn-success">â¬†ï¸ Upload vÃ  Import</button>
  </form>

  <!-- progress bar -->
  <div id="progressContainer" style="margin-top: 15px; display: none;">
    <label>Äang táº£i lÃªn...</label>
    <div style="width: 100%; background-color: #eee; border-radius: 4px;">
      <div id="progressBar" style="width: 0%; height: 20px; background-color: #4caf50; text-align: center; color: white;">
        0%
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- âœ… SimpleMDE Markdown -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>

<!-- âœ… Upload vÃ  AI tag script -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  // SimpleMDE cho pháº§n statement
  const textarea = document.querySelector("#id_statement");
  if (textarea) {
    new SimpleMDE({
      element: textarea,
      spellChecker: false,
      autosave: { enabled: true, delay: 1500, uniqueId: "problem_statement" },
      renderingConfig: { singleLineBreaks: false, codeSyntaxHighlighting: true },
      toolbar: ["bold","italic","heading","|","quote","unordered-list","ordered-list","|",
                "link","image","table","code","|","preview","side-by-side","fullscreen","|","guide"],
      placeholder: "âœï¸ Nháº­p ná»™i dung bÃ i toÃ¡n báº±ng Markdown..."
    });
  }

  // Thanh tiáº¿n trÃ¬nh upload
  const uploadForm = document.getElementById("uploadForm");
  if (uploadForm) {
    uploadForm.addEventListener("submit", function(e) {
      e.preventDefault();
      const data = new FormData(uploadForm);
      const xhr = new XMLHttpRequest();
      const bar = document.getElementById("progressBar");
      const container = document.getElementById("progressContainer");
      xhr.open("POST", uploadForm.action, true);
      xhr.upload.addEventListener("loadstart", function() {
        container.style.display = "block";
        bar.style.width = "0%";
        bar.textContent = "0%";
      });
      xhr.upload.addEventListener("progress", function(e) {
        if (e.lengthComputable) {
          const percent = Math.round((e.loaded / e.total) * 100);
          bar.style.width = percent + "%";
          bar.textContent = percent + "%";
        }
      });
      xhr.onload = function() {
        if (xhr.status === 200) {
          bar.style.backgroundColor = "#2196F3";
          bar.textContent = "âœ… HoÃ n táº¥t!";
          setTimeout(() => window.location.reload(), 1000);
        } else {
          alert("âŒ Lá»—i khi upload test. Vui lÃ²ng thá»­ láº¡i.");
          bar.style.backgroundColor = "red";
        }
      };
      xhr.send(data);
    });
  }

  // Gá»£i Ã½ tag AI
  const aiBtn = document.getElementById("aiTagBtn");
  const tagField = document.getElementById("id_tags");
  if (aiBtn && tagField) {
    aiBtn.addEventListener("click", async () => {
      aiBtn.disabled = true;
      aiBtn.textContent = "â³ Äang phÃ¢n tÃ­ch...";
      const statement = textarea ? textarea.value : "";
      try {
        const res = await fetch(`/admin/problems/ai_suggest_tags/`, {
          method: "POST",
          headers: {"Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}"},
          body: JSON.stringify({ statement })
        });
        const data = await res.json();
        if (data.tags) tagField.value = data.tags.join(", ");
        aiBtn.textContent = "âœ¨ Äá» xuáº¥t láº¡i";
      } catch {
        alert("Lá»—i khi láº¥y gá»£i Ã½ tá»« AI.");
        aiBtn.textContent = "ğŸ§  Gá»£i Ã½ Tag AI";
      }
      aiBtn.disabled = false;
    });
  }
});
</script>

<style>
.container{max-width:900px;margin:auto;font-family:sans-serif;}
a.button{display:inline-block;background:#3c8dbc;color:white;padding:6px 12px;border-radius:6px;text-decoration:none;}
a.button:hover{background:#337ab7;}
.btn{cursor:pointer;border:none;padding:6px 12px;border-radius:6px;}
.btn-info{background:#17a2b8;color:white;}
.btn-success{background:#28a745;color:white;}
</style>
{% endblock %}
