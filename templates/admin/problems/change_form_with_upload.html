{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<div class="container">

  <!-- Markdown field -->
  <h2>🧾 Problem Information</h2>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ adminform.form.as_p }}
    <input type="submit" class="default" value="💾 Lưu thay đổi">
  </form>

  <!-- Nút hiện test -->
  <hr>
  <button id="toggle-tests-btn" class="button">👁 Hiện danh sách test case</button>
  <div id="testcase-section" style="display:none;">
    <div id="testcase-content" style="text-align:center;margin-top:10px;">⏳ Chưa tải test case...</div>
  </div>

  <!-- Upload ZIP -->
  {% if show_upload_button %}
  <hr>
  <h3>📦 Upload ZIP Test Cases</h3>
  <form action="{% url 'admin:upload_tests' original.id %}" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" name="zip_file" accept=".zip" required style="margin-bottom:10px;">
    <button type="submit" class="default btn btn-success">⬆️ Upload và Import</button>
  </form>
  {% endif %}
</div>

<!-- Scripts -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  // Markdown
  const t = document.querySelector("#id_statement");
  if (t) new SimpleMDE({element:t, spellChecker:false, autosave:{enabled:true,delay:1000,uniqueId:"statement"}});

  // Test AJAX
  const btn = document.getElementById("toggle-tests-btn");
  const section = document.getElementById("testcase-section");
  const content = document.getElementById("testcase-content");
  let loaded=false,page=1;
  btn.onclick=()=>{
    const show = section.style.display==="none";
    section.style.display = show?"block":"none";
    btn.textContent = show?"🙈 Ẩn danh sách test case":"👁 Hiện danh sách test case";
    if(show && !loaded) load(page);
  };
  function load(p){
    content.innerHTML="⏳ Đang tải...";
    fetch(`${window.location.pathname}load_tests/?page=${p}`)
    .then(r=>r.json()).then(d=>{
      content.innerHTML = p===1?d.html:content.innerHTML+d.html;
      loaded=true;
      if(d.has_next){
        const b=document.getElementById("load-more-tests");
        if(b){b.onclick=()=>{b.remove();load(d.next_page);};}
      }
    }).catch(()=>{content.innerHTML="⚠️ Lỗi tải test";});
  }
});
</script>

<style>
.container{max-width:900px;margin:auto;font-family:sans-serif;}
#toggle-tests-btn{background:#3c8dbc;color:white;padding:6px 12px;border:none;border-radius:5px;cursor:pointer;}
#toggle-tests-btn:hover{background:#337ab7;}
#load-more-tests{margin-top:10px;padding:6px 10px;border:1px solid #ccc;border-radius:5px;cursor:pointer;}
</style>
{% endblock %}
