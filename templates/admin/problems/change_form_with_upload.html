{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block content %}
<h1>ğŸ“¦ Upload Test Cases cho {{ problem.title }}</h1>
<p>Chá»n tá»‡p .zip chá»©a cÃ¡c file <code>.inp</code> vÃ  <code>.out</code>.</p>

<form id="uploadForm" method="post" enctype="multipart/form-data" style="margin-top: 20px;">
  {% csrf_token %}
  {{ form.as_p }}

  <!-- ğŸ§  Gá»£i Ã½ Tag AI -->
  <div style="margin: 15px 0;">
    <label for="id_tags"><b>Tags:</b></label>
    <input type="text" id="id_tags" name="tags" value="{{ problem.tags }}" class="vTextField" style="width: 100%; max-width: 400px;">
    <button type="button" class="button btn" id="aiTagBtn" style="margin-left: 8px;">ğŸ§  Gá»£i Ã½ Tag AI</button>
  </div>

  <button type="submit" class="button btn btn-success">ğŸš€ Upload</button>
</form>

<!-- Progress bar -->
<div id="progressContainer" style="margin-top: 20px; display: none;">
  <label>Äang táº£i lÃªn...</label>
  <div style="width: 100%; background-color: #eee; border-radius: 4px;">
    <div id="progressBar" style="width: 0%; height: 20px; background-color: #4caf50; text-align: center; color: white;">
      0%
    </div>
  </div>
</div>

<script>
// ========== ğŸš€ Upload progress ==========
document.getElementById("uploadForm").addEventListener("submit", function (e) {
  e.preventDefault();
  const form = e.target;
  const data = new FormData(form);
  const xhr = new XMLHttpRequest();
  const bar = document.getElementById("progressBar");
  const container = document.getElementById("progressContainer");

  xhr.open("POST", "", true);
  xhr.upload.addEventListener("loadstart", function () {
    container.style.display = "block";
    bar.style.width = "0%";
    bar.textContent = "0%";
  });
  xhr.upload.addEventListener("progress", function (e) {
    if (e.lengthComputable) {
      const percent = Math.round((e.loaded / e.total) * 100);
      bar.style.width = percent + "%";
      bar.textContent = percent + "%";
    }
  });
  xhr.onload = function () {
    if (xhr.status === 200) {
      bar.style.backgroundColor = "#2196F3";
      bar.textContent = "âœ… HoÃ n táº¥t!";
      setTimeout(() => {
        window.location.href = "{{ request.path|slice:':-13' }}change/";
      }, 1200);
    } else {
      alert("âŒ Lá»—i khi upload test. Vui lÃ²ng thá»­ láº¡i.");
      bar.style.backgroundColor = "red";
    }
  };
  xhr.send(data);
});


// ========== ğŸ§  AI Tag Suggestion ==========
document.addEventListener("DOMContentLoaded", function() {
  const aiBtn = document.getElementById("aiTagBtn");
  const tagsField = document.getElementById("id_tags");

  if (aiBtn && tagsField) {
    aiBtn.addEventListener("click", async function() {
      const statementField = document.querySelector("#id_statement");
      const statement = statementField ? statementField.value : "";
      aiBtn.disabled = true;
      aiBtn.textContent = "â³ Äang gá»£i Ã½...";

      try {
        const res = await fetch("/admin/ai_suggest_tags/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify({ statement })
        });

        const data = await res.json();
        aiBtn.disabled = false;
        aiBtn.textContent = "ğŸ§  Gá»£i Ã½ Tag AI";

        if (data.tags) {
          tagsField.value = data.tags.join(", ");
          alert("âœ… AI Ä‘á» xuáº¥t: " + data.tags.join(", "));
        } else {
          alert("âš ï¸ KhÃ´ng nháº­n dáº¡ng Ä‘Æ°á»£c chá»§ Ä‘á».");
        }
      } catch (err) {
        aiBtn.disabled = false;
        aiBtn.textContent = "ğŸ§  Gá»£i Ã½ Tag AI";
        alert("âŒ Lá»—i khi gá»i AI gá»£i Ã½ tag.");
      }
    });
  }
});
</script>

<a href="/admin/problems/problem/{{ problem.id }}/change/" style="display:block; margin-top:15px;">â† Quay láº¡i Problem</a>
{% endblock %}
