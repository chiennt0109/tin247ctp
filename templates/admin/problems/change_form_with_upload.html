{% extends "admin/base_site.html" %}
{% load static %}
{% block content %}
<div class="container">
  <h2>{{ original.code }} ‚Äì {{ original.title }}</h2>

  <form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    {{ adminform.form.as_p }}
    <div class="submit-row">
      <input type="submit" value="üíæ L∆∞u thay ƒë·ªïi" class="default">
    </div>
  </form>

  <hr>
  <h3>ü§ñ AI H·ªó tr·ª£ nh·∫≠p li·ªáu</h3>
  <button type="button" id="aiAnalyze" class="button">‚ú® Ph√¢n t√≠ch & G·ª£i √Ω to√†n di·ªán</button>
  <p id="aiResult" style="margin-top:10px;color:#333;"></p>

  <hr>
  <h3>üëÅ Test Cases</h3>
  {% if original and original.id %}
    <a href="{% url 'admin:view_tests' original.id %}" target="_blank" class="button">üëÅ M·ªü danh s√°ch test</a>
  {% else %}
    <p style="color:gray;">üí° H√£y l∆∞u b√†i to√°n tr∆∞·ªõc khi xem test case.</p>
  {% endif %}

  {% if original and original.id %}
  <hr>
  <h3>üì¶ Upload ZIP Test Cases</h3>
  <form action="{% url 'admin:upload_tests' original.id %}" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" name="zip_file" accept=".zip" required style="margin-bottom:10px;">
    <button type="submit" class="default btn btn-success">‚¨ÜÔ∏è Upload v√† Import</button>
  </form>
  {% endif %}
</div>

<script>
document.getElementById("aiAnalyze").addEventListener("click", async () => {
  const title = document.querySelector("#id_title").value;
  const statement = document.querySelector("#id_statement").value;
  const res = await fetch("/problems/ai_analyze_problem/", {
    method: "POST",
    headers: {"Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}"},
    body: JSON.stringify({title, statement})
  });
  const data = await res.json();
  if (data.error) return alert("‚ùå " + data.error);
  document.querySelector("#id_code").value = data.code;
  document.querySelector("#id_difficulty").value = data.difficulty;
  document.getElementById("aiResult").innerHTML =
    `‚úÖ <b>M√£:</b> ${data.code} ‚Äî <b>ƒê·ªô kh√≥:</b> ${data.difficulty} ‚Äî <b>Tags:</b> ${data.tags.join(", ")}`;
});
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const textarea = document.querySelector("#id_statement");
  if (textarea) {
    new SimpleMDE({
      element: textarea,
      spellChecker: false,
      autosave: { enabled: true, delay: 1500, uniqueId: "problem_statement" },
      toolbar: ["bold","italic","heading","|","quote","unordered-list","ordered-list","|",
                "link","image","table","code","|","preview","side-by-side","fullscreen","|","guide"],
      placeholder: "‚úèÔ∏è Nh·∫≠p n·ªôi dung b√†i to√°n b·∫±ng Markdown..."
    });
  }
});
</script>

<style>
.container{max-width:900px;margin:auto;font-family:sans-serif;}
a.button{display:inline-block;background:#3c8dbc;color:white;padding:6px 12px;border-radius:6px;text-decoration:none;}
a.button:hover{background:#337ab7;}
</style>
{% endblock %}
