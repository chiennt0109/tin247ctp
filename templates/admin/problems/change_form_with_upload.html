{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<div class="container" style="max-width:1100px;margin:auto;font-family:sans-serif;">
  <h2 style="display:flex;align-items:center;gap:10px;">
    âš™ï¸ {{ original.code }} â€“ {{ original.title }}
  </h2>

  <div style="display:grid;grid-template-columns:2fr 1fr;gap:30px;margin-top:20px;">
    <!-- ======================================= -->
    <!-- Cá»˜T TRÃI: FORM CHá»ˆNH Sá»¬A BÃ€I TOÃN -->
    <!-- ======================================= -->
    <div>
      <form method="post" enctype="multipart/form-data" novalidate id="problemForm">
        {% csrf_token %}
        {{ adminform.form.as_p }}

        <div class="submit-row" style="margin-top:20px;">
          <input type="submit" value="ğŸ’¾ LÆ°u thay Ä‘á»•i" class="default">
        </div>
      </form>

      <hr style="margin:30px 0;">

      <!-- ================== TEST CASE ================== -->
      <h3>ğŸ‘ Kiá»ƒm tra Test Cases</h3>
      {% if original and original.id %}
        <p>
          <a href="{% url 'admin:view_tests' original.id %}"
             target="_blank"
             class="button"
             style="display:inline-block;background:#3c8dbc;color:white;
                    padding:6px 12px;border-radius:6px;text-decoration:none;">
            ğŸ‘ Má»Ÿ danh sÃ¡ch test
          </a>
        </p>
      {% else %}
        <p style="color:gray;">ğŸ’¡ HÃ£y lÆ°u bÃ i toÃ¡n trÆ°á»›c khi xem test case.</p>
      {% endif %}

      {% if show_upload_button %}
      <hr style="margin:30px 0;">
      <h3>ğŸ“¦ Upload ZIP Test Cases</h3>
      <p>Chá»n file .zip chá»©a cÃ¡c file <code>.inp</code> / <code>.out</code>.</p>

      <form id="uploadForm" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="file" name="zip_file" accept=".zip" required style="margin-bottom:10px;">
        <button type="submit" class="default" style="background:#28a745;color:white;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;">
          ğŸš€ Upload
        </button>
      </form>

      <div id="progressContainer" style="margin-top: 10px; display: none;">
        <label>Äang táº£i lÃªn...</label>
        <div style="width: 100%; background-color: #eee; border-radius: 4px;">
          <div id="progressBar"
               style="width: 0%; height: 20px; background-color: #4caf50;
                      text-align: center; color: white; font-size:12px;">
            0%
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- ======================================= -->
    <!-- Cá»˜T PHáº¢I: Há»– TRá»¢ AI -->
    <!-- ======================================= -->
    <div style="background:#f9f9f9;padding:20px;border-radius:10px;border:1px solid #ddd;">
      <h3 style="margin-top:0;">ğŸ§  CÃ´ng cá»¥ AI há»— trá»£</h3>

      <div>
        <button id="ai-tag-btn"
                style="width:100%;background:#6f42c1;color:#fff;border:none;
                       padding:8px;border-radius:6px;cursor:pointer;font-size:15px;">
          âœ¨ Gá»£i Ã½ Tag tá»« ná»™i dung Ä‘á» bÃ i
        </button>
        <small style="display:block;color:#666;margin-top:6px;">
          AI sáº½ Ä‘á»c ná»™i dung Ä‘á» bÃ i, phÃ¢n tÃ­ch vÃ  gá»£i Ã½ tag phÃ¹ há»£p (VD: Graph, DP, Greedy...).
        </small>
      </div>

      <hr>

      <div>
        <button id="ai-summary-btn"
                style="width:100%;background:#17a2b8;color:#fff;border:none;
                       padding:8px;border-radius:6px;cursor:pointer;font-size:15px;">
          ğŸª„ TÃ³m táº¯t Ä‘á» bÃ i (demo)
        </button>
        <small style="display:block;color:#666;margin-top:6px;">
          Hiá»‡n chá»‰ mÃ´ phá»ng, cÃ³ thá»ƒ thay báº±ng API AI tháº­t sau nÃ y.
        </small>
      </div>
    </div>
  </div>
</div>

<!-- ================== SIMPLEMDE ================== -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const textarea = document.querySelector("#id_statement");
  if (textarea) {
    new SimpleMDE({
      element: textarea,
      spellChecker: false,
      autosave: { enabled: true, delay: 1500, uniqueId: "problem_statement" },
      renderingConfig: { singleLineBreaks: false, codeSyntaxHighlighting: true },
      toolbar: ["bold","italic","heading","|","quote","unordered-list","ordered-list","|",
                "link","image","table","code","|","preview","side-by-side","fullscreen","|","guide"],
      placeholder: "âœï¸ Nháº­p ná»™i dung bÃ i toÃ¡n báº±ng Markdown..."
    });
  }
});
</script>

<!-- ================== AI TAG / SUMMARY ================== -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const tagBtn = document.getElementById("ai-tag-btn");
  const summaryBtn = document.getElementById("ai-summary-btn");
  const statement = document.getElementById("id_statement");

  // hÃ m tÃ¬m field tags tháº­t trong form
  function getTagSelect() {
    return document.querySelector('select[name="tags"]');
  }

  // ===================== Gá»¢I Ã TAG =====================
  tagBtn?.addEventListener("click", async function() {
    const tagSelect = getTagSelect();
    if (!statement || !tagSelect) {
      alert("KhÃ´ng tÃ¬m tháº¥y ná»™i dung Ä‘á» bÃ i hoáº·c trÆ°á»ng tags!");
      return;
    }

    tagBtn.disabled = true;
    tagBtn.textContent = "â³ Äang gá»£i Ã½...";
    try {
      const res = await fetch("/problems/ai_suggest_tags/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ statement: statement.value })
      });

      if (res.ok) {
        const data = await res.json();
        const tags = data.tags || [];
        if (tags.length === 0) {
          alert("âš ï¸ KhÃ´ng gá»£i Ã½ Ä‘Æ°á»£c tag nÃ o.");
        } else {
          // gÃ¡n trá»±c tiáº¿p vÃ o field select multiple
          for (const option of tagSelect.options) {
            option.selected = tags.includes(option.text);
          }
          tagSelect.scrollIntoView({behavior:"smooth"});
          alert("âœ… ÄÃ£ gá»£i Ã½ tag: " + tags.join(", "));
        }
      } else {
        alert("Lá»—i server khi gá»i AI Tag (" + res.status + ")");
      }
    } catch(e) {
      console.error(e);
      alert("âŒ KhÃ´ng thá»ƒ káº¿t ná»‘i tá»›i AI Tag.");
    } finally {
      tagBtn.disabled = false;
      tagBtn.textContent = "âœ¨ Gá»£i Ã½ Tag tá»« ná»™i dung Ä‘á» bÃ i";
    }
  });

  // ===================== TÃ“M Táº®T (demo) =====================
  summaryBtn?.addEventListener("click", function() {
    if (!statement) return;
    const text = statement.value.trim();
    if (!text) { alert("Äá» bÃ i trá»‘ng."); return; }

    const sentences = text.split(/[.!?]/).filter(s => s.trim().length > 0);
    const summary = sentences.slice(0, 3).join(". ") + "...";
    alert("ğŸ“˜ TÃ³m táº¯t (demo):\n\n" + summary);
  });
});
</script>

<!-- ================== UPLOAD BAR ================== -->
<script>
const uploadForm = document.getElementById("uploadForm");
if (uploadForm) {
  uploadForm.addEventListener("submit", function(e) {
    e.preventDefault();
    const data = new FormData(this);
    const xhr = new XMLHttpRequest();
    const bar = document.getElementById("progressBar");
    const container = document.getElementById("progressContainer");

    xhr.open("POST", "", true);
    xhr.upload.addEventListener("loadstart", () => {
      container.style.display = "block";
      bar.style.width = "0%";
      bar.textContent = "0%";
    });
    xhr.upload.addEventListener("progress", e => {
      if (e.lengthComputable) {
        const percent = Math.round((e.loaded / e.total) * 100);
        bar.style.width = percent + "%";
        bar.textContent = percent + "%";
      }
    });
    xhr.onload = function() {
      if (xhr.status === 200) {
        bar.style.backgroundColor = "#2196F3";
        bar.textContent = "âœ… HoÃ n táº¥t!";
        setTimeout(() => {
          location.reload();
        }, 1000);
      } else {
        alert("âŒ Lá»—i khi upload test.");
        bar.style.backgroundColor = "red";
      }
    };
    xhr.send(data);
  });
}
</script>

{% endblock %}
