{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
<style>
.container{max-width:900px;margin:auto;font-family:sans-serif;}
a.button{display:inline-block;background:#3c8dbc;color:white;padding:6px 12px;border-radius:6px;text-decoration:none;}
a.button:hover{background:#337ab7;}
</style>
{% endblock %}

{% block content %}
<div class="container">
  <h2>{{ original.code }} – {{ original.title }}</h2>

  <form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    {{ adminform.form.as_p }}

    <div class="submit-row">
      <input type="submit" value="💾 Lưu thay đổi" class="default">
    </div>
  </form>

  <hr>
  <h3>🤖 AI hỗ trợ nhập liệu</h3>

  <button type="button" id="ai_generate" class="button">✨ Sinh đề tự động</button>
  <button type="button" id="ai_format" class="button">✅ Kiểm tra format</button>
  <button type="button" id="ai_samples" class="button">🧪 Sinh Sample Input/Output</button>
  <p id="aiStatus" style="margin-top:10px;color:#333;"></p>

  <hr>
  <h3>📦 Upload Test ZIP</h3>
  {% if original and original.id %}
  <form action="{% url 'admin:upload_tests' original.id %}" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" name="zip_file" accept=".zip" required style="margin-bottom:10px;">
    <button type="submit" class="default btn btn-success">⬆️ Upload & Import</button>
  </form>

  <a href="{% url 'admin:view_tests' original.id %}" target="_blank" class="button">👁 Xem test</a>
  {% else %}
  <p>💡 Lưu bài trước để upload test</p>
  {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const textarea = document.querySelector("#id_statement");
  if (textarea) {
    new SimpleMDE({
      element: textarea,
      spellChecker: false,
      autosave: { enabled: true, delay: 1500, uniqueId: "problem_statement" },
      toolbar: ["bold","italic","heading","|","quote","unordered-list","ordered-list","|","link","image","table","code","|","preview","side-by-side","fullscreen"]
    });
  }

  async function post(url, body="") {
    const res = await fetch(url, {method:"POST",body});
    return await res.json();
  }

  document.getElementById("ai_generate").onclick = async () => {
    const d = await fetch("/problems/admin_ai_generate/").then(r=>r.json());
    document.getElementById("id_statement").value = d.content;
    document.getElementById("aiStatus").innerText = "✅ Đã sinh đề!";
  };

  document.getElementById("ai_samples").onclick = async () => {
    const text = document.getElementById("id_statement").value;
    await post("/problems/admin_ai_samples/", text);
    document.getElementById("aiStatus").innerText = "✅ Sample ready!";
  };

  document.getElementById("ai_format").onclick = async () => {
    const text = document.getElementById("id_statement").value;
    const d = await post("/problems/admin_ai_check/", text);
    document.getElementById("aiStatus").innerText = "📌 " + d.msg;
  };
});
</script>
{% endblock %}
