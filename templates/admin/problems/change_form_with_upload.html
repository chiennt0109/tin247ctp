{% extends "admin/change_form.html" %}
{% load static %}

{% block content %}
<div class="container">

  <!-- üß© N√∫t ·∫©n/hi·ªán danh s√°ch test -->
  <button id="toggle-tests-btn" class="button" type="button" style="margin-bottom:10px;">
    üëÅ Hi·ªán danh s√°ch test case
  </button>

  <!-- Khu v·ª±c ch·ª©a danh s√°ch test (AJAX load) -->
  <div id="testcase-section" style="display:none;">
    <div id="testcase-content" style="margin-top:10px; text-align:center;">‚è≥ Ch∆∞a t·∫£i test case...</div>
  </div>

  <!-- üßæ Form ch√≠nh (ch·ª©a c√°c tr∆∞·ªùng Problem + Inline kh√°c) -->
  {{ block.super }}

  <!-- üì¶ Upload ZIP test case -->
  {% if show_upload_button %}
  <hr>
  <h3>üì¶ Upload ZIP Test Cases</h3>
  <form action="{% url 'admin:upload_tests' original.id %}" method="post" enctype="multipart/form-data" style="margin-top: 1em;">
    {% csrf_token %}
    <p>
      <input type="file" name="zip_file" accept=".zip" required style="margin-bottom:8px;">
    </p>
    <button type="submit" class="default btn btn-success">‚¨ÜÔ∏è Upload v√† Import</button>
  </form>
  {% endif %}
</div>

<!-- ============================================================
üß© SCRIPT: AJAX t·∫£i test + SimpleMDE Markdown Editor
============================================================ -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  // ·∫®n/hi·ªán danh s√°ch test case
  const btn = document.getElementById("toggle-tests-btn");
  const section = document.getElementById("testcase-section");
  const content = document.getElementById("testcase-content");
  let visible = false;
  let loaded = false;
  let currentPage = 1;

  btn.addEventListener("click", () => {
    visible = !visible;
    section.style.display = visible ? "block" : "none";
    btn.textContent = visible ? "üôà ·∫®n danh s√°ch test case" : "üëÅ Hi·ªán danh s√°ch test case";

    if (visible && !loaded) loadPage(currentPage);
  });

  // H√†m AJAX t·∫£i test theo trang
  function loadPage(page) {
    content.innerHTML = "‚è≥ ƒêang t·∫£i...";
    fetch(`${window.location.pathname}load_tests/?page=${page}`)
      .then(res => res.json())
      .then(data => {
        if (page === 1) content.innerHTML = data.html;
        else content.insertAdjacentHTML("beforeend", data.html);

        loaded = true;
        if (data.has_next) {
          const moreBtn = document.getElementById("load-more-tests");
          if (moreBtn) {
            moreBtn.addEventListener("click", () => {
              currentPage = data.next_page;
              moreBtn.disabled = true;
              moreBtn.textContent = "‚è≥ ƒêang t·∫£i...";
              loadPage(currentPage);
              moreBtn.remove();
            });
          }
        }
      })
      .catch(() => {
        content.innerHTML = "<p style='color:red;'>‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i test case.</p>";
      });
  }

  // SimpleMDE Markdown Editor cho tr∆∞·ªùng Statement
  const textarea = document.querySelector("#id_statement");
  if (textarea) {
    new SimpleMDE({
      element: textarea,
      spellChecker: false,
      autosave: { enabled: true, delay: 1500, uniqueId: "problem_statement" },
      renderingConfig: { singleLineBreaks: false, codeSyntaxHighlighting: true },
      toolbar: [
        "bold", "italic", "heading", "|",
        "quote", "unordered-list", "ordered-list", "|",
        "link", "image", "table", "code", "|",
        "preview", "side-by-side", "fullscreen", "|",
        "guide"
      ],
      placeholder: "‚úèÔ∏è Nh·∫≠p n·ªôi dung b√†i to√°n b·∫±ng Markdown..."
    });
  }
});
</script>

<!-- SimpleMDE assets -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>

<!-- M·ªôt ch√∫t CSS tinh ch·ªânh -->
<style>
.container { max-width: 1000px; }
#toggle-tests-btn {
  background-color: #3c8dbc;
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-size: 14px;
}
#toggle-tests-btn:hover { background-color: #337ab7; }
#load-more-tests {
  background-color: #f0f0f0;
  border: 1px solid #ddd;
  padding: 6px 10px;
  border-radius: 4px;
  cursor: pointer;
}
#load-more-tests:hover { background-color: #e6e6e6; }
</style>
{% endblock %}
