{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container-fluid py-3" style="max-width:1450px;">
  <div class="row g-4">
    <!-- üß© C·ªôt tr√°i: ƒê·ªÅ b√†i -->
    <div class="col-lg-5 col-md-12">
      <div class="card border-0 shadow-sm rounded-4 h-100 p-4" style="font-size:14px;">
        <h5 class="fw-bold text-primary mb-2">{{ problem.title }}</h5>
        <div class="text-muted small mb-2">
          M√£: <b>{{ problem.code }}</b> &nbsp;|&nbsp; ‚è± Gi·ªõi h·∫°n: {{ problem.time_limit|default:"6" }}s
        </div>
        <hr>
        <textarea id="md-src" hidden>{{ problem.statement }}</textarea>
        <div id="statement" class="markdown-body" style="max-height:70vh; overflow:auto;"></div>
      </div>
    </div>

    <!-- üíª C·ªôt ph·∫£i: Code editor -->
    <div class="col-lg-7 col-md-12 position-relative">
      <div class="card border-0 shadow-sm rounded-4 p-3" style="font-size:14px;">
        <div class="d-flex justify-content-between align-items-center flex-wrap mb-2">
          <h5 class="fw-semibold text-dark mb-2">üöÄ N·ªôp b√†i</h5>
          <a href="{% if contest_id %}/contests/{{ contest_id }}/{% else %}/problems/{% endif %}" 
             class="btn btn-sm btn-outline-secondary rounded-pill shadow-sm">
            ‚¨ÖÔ∏è Quay l·∫°i
          </a>
        </div>

        <form method="POST" id="submitForm">
          {% csrf_token %}
          <input type="hidden" name="contest_id" value="{{ contest_id|default:'' }}">
          <div class="mb-3">
            <label for="language" class="form-label small fw-semibold">Ng√¥n ng·ªØ l·∫≠p tr√¨nh</label>
            <select class="form-select form-select-sm" id="language" name="language" required onchange="changeMode()">
              <option value="">-- Ch·ªçn ng√¥n ng·ªØ --</option>
              <option value="python">üêç Python 3</option>
              <option value="pypy">‚ö° PyPy 3</option>
              <option value="cpp">üíª C++17</option>
              <option value="java">‚òï Java</option>
            </select>
          </div>

          <!-- üñäÔ∏è Code Editor -->
          <div class="position-relative mb-3">
            <div id="editor" class="rounded-3 border shadow-sm" style="height:480px;"># Vi·∫øt code c·ªßa b·∫°n t·∫°i ƒë√¢y...</div>
            <textarea name="source" id="source" style="display:none;"></textarea>
          </div>

          <!-- üîç K·∫øt qu·∫£ -->
          <div id="result-box" class="border rounded-3 p-3 bg-light" style="display:none;">
            <div id="result-text" class="fw-semibold text-center text-muted small">‚è≥ ƒêang ch·∫•m...</div>
          </div>

          <!-- N√∫t h√†nh ƒë·ªông -->
          <div class="d-flex justify-content-end gap-2 mt-3">
            <button id="submitBtn" type="button" class="btn btn-primary rounded-pill px-4 py-2 fw-semibold shadow-sm">
              üíæ N·ªôp b√†i
            </button>
            <a href="{% if contest_id %}/contests/{{ contest_id }}/{% else %}/problems/{% endif %}" 
               class="btn btn-outline-secondary rounded-pill px-3 py-2 shadow-sm">
              ‚¨ÖÔ∏è Quay l·∫°i
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- üåà JS Dependencies -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.3/src-min-noconflict/ace.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.3/src-min-noconflict/ext-language_tools.js"></script>

<script>
// ‚úÖ Render Markdown
(function(){
  const src=document.getElementById('md-src');
  const out=document.getElementById('statement');
  if(src && out){
    marked.setOptions({
      breaks:true,gfm:true,
      highlight:(code,lang)=>{try{return hljs.highlight(code,{language:lang||'plaintext'}).value}catch{return code}}
    });
    const html=marked.parse(src.value||'');
    out.innerHTML=DOMPurify.sanitize(html,{USE_PROFILES:{html:true}});
    if(window.renderMathInElement){
      renderMathInElement(out,{delimiters:[{left:"$$",right:"$$",display:true},{left:"$",right:"$",display:false}],throwOnError:false});
    }
    out.querySelectorAll('pre code').forEach(el=>hljs.highlightElement(el));
  }
})();

// ‚úÖ Ace Editor setup
const editor = ace.edit("editor");
editor.setTheme("ace/theme/github");
editor.session.setMode("ace/mode/python");
editor.setOptions({
  enableBasicAutocompletion: true,
  enableLiveAutocompletion: true,
  showPrintMargin: false,
  fontSize: "13px",
  wrap: true,
  highlightActiveLine: true,
  fontFamily: "Fira Code, monospace",
});
function changeMode(){
  const lang=document.getElementById("language").value;
  if(lang==="cpp")editor.session.setMode("ace/mode/c_cpp");
  else if(lang==="java")editor.session.setMode("ace/mode/java");
  else editor.session.setMode("ace/mode/python");
}

// ‚úÖ G·ª≠i b√†i & c·∫≠p nh·∫≠t k·∫øt qu·∫£ th·ª±c t·∫ø
document.getElementById("submitBtn").addEventListener("click", async function(){
  const lang=document.getElementById("language").value;
  const code=editor.getValue().trim();
  const csrf=document.querySelector('[name=csrfmiddlewaretoken]').value;
  const contest_id="{{ contest_id|default:'' }}";
  if(!lang)return alert("‚ö†Ô∏è B·∫°n ch∆∞a ch·ªçn ng√¥n ng·ªØ!");
  if(code.length===0)return alert("‚ö†Ô∏è B·∫°n ch∆∞a nh·∫≠p m√£ ngu·ªìn!");
  const box=document.getElementById("result-box"),text=document.getElementById("result-text");
  box.style.display="block"; text.innerHTML="‚è≥ ƒêang n·ªôp v√† ch·∫•m...";

  try{
    const res = await fetch(window.location.href,{
      method:"POST",
      headers:{"X-CSRFToken":csrf,"Content-Type":"application/x-www-form-urlencoded"},
      body:new URLSearchParams({language:lang,source:code,contest_id})
    });
    const redirectUrl = res.url || "";
    if(res.redirected && redirectUrl.includes("/submissions/")){
      const submissionId = redirectUrl.split("/submissions/")[1].split("/")[0];
      checkResult(submissionId);
    } else text.innerHTML = "‚ö†Ô∏è G·ª≠i b√†i kh√¥ng th√†nh c√¥ng.";
  }catch(e){text.innerHTML="‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi m√°y ch·ªß.";}
});

// üîÅ Poll k·∫øt qu·∫£ th·ª±c t·ª´ server
async function checkResult(submissionId){
  const text=document.getElementById("result-text");
  try{
    let verdict="Pending";
    for(let i=0;i<8;i++){
      const res=await fetch(`/submissions/${submissionId}/`);
      const html=await res.text();
      if(html.includes("Accepted")){verdict="Accepted";break;}
      if(html.includes("Wrong Answer")){verdict="Wrong Answer";break;}
      if(html.includes("Runtime Error")){verdict="Runtime Error";break;}
      if(html.includes("Time Limit")){verdict="Time Limit Exceeded";break;}
      await new Promise(r=>setTimeout(r,1500));
    }
    const color = verdict==="Accepted"?"text-success":(verdict==="Pending"?"text-warning":"text-danger");
    text.innerHTML = `üéØ K·∫øt qu·∫£: <span class="${color}">${verdict}</span>`;
  }catch{ text.innerHTML="‚ö†Ô∏è Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c k·∫øt qu·∫£."; }
}
</script>

<style>
.markdown-body pre code{background:#f8fafc;border-radius:8px;padding:6px 10px;}
select.form-select{border-radius:10px;padding:0.4rem 0.8rem;}
.btn{font-size:13px;}
.btn-primary{background:linear-gradient(90deg,#2563eb,#1e3a8a);border:none;}
.btn-primary:hover{background:linear-gradient(90deg,#1d4ed8,#1e40af);}
.card{transition:.2s;} .card:hover{box-shadow:0 8px 22px rgba(0,0,0,0.08);}
</style>
{% endblock %}
