{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container-fluid py-3" style="max-width:1450px;">
  <div class="row g-4">
    <!-- ğŸ§© Cá»™t trÃ¡i: Äá» bÃ i -->
    <div class="col-lg-5 col-md-12">
      <div class="card border-0 shadow-sm rounded-4 h-100 p-4" style="font-size:14px;">
        <h5 class="fw-bold text-primary mb-2">{{ problem.title }}</h5>
        <div class="text-muted small mb-2">
          MÃ£: <b>{{ problem.code }}</b> &nbsp;|&nbsp; â± Giá»›i háº¡n: {{ problem.time_limit|default:"6" }}s
        </div>
        <hr>
        <textarea id="md-src" hidden>{{ problem.statement }}</textarea>
        <div id="statement" class="markdown-body" style="max-height:70vh; overflow:auto;"></div>
      </div>
    </div>

    <!-- ğŸ’» Cá»™t pháº£i: Code editor -->
    <div class="col-lg-7 col-md-12 position-relative">
      <div class="card border-0 shadow-sm rounded-4 p-3" style="font-size:14px;">
        <div class="d-flex justify-content-between align-items-center flex-wrap mb-2">
          <h5 class="fw-semibold text-dark mb-2">ğŸš€ Ná»™p bÃ i</h5>
          <a href="{% if contest_id %}/contests/{{ contest_id }}/{% else %}/problems/{% endif %}" 
             class="btn btn-sm btn-outline-secondary rounded-pill shadow-sm">
            â¬…ï¸ Quay láº¡i
          </a>
        </div>

        <!-- CÃ¡c nÃºt hÃ nh Ä‘á»™ng -->
        <div class="d-flex gap-2 mb-3">
          <button id="submitBtn" type="button" class="btn btn-primary rounded-pill px-3 py-1 fw-semibold shadow-sm">
            ğŸ’¾ Ná»™p bÃ i
          </button>
          <button id="clearBtn" type="button" class="btn btn-outline-secondary rounded-pill px-3 py-1 shadow-sm">
            ğŸ§¹ XÃ³a code
          </button>
          <button id="sampleBtn" type="button" class="btn btn-outline-info rounded-pill px-3 py-1 shadow-sm">
            ğŸ“‹ Copy máº«u
          </button>
        </div>

        <form method="POST" id="submitForm">
          {% csrf_token %}
          <input type="hidden" name="contest_id" value="{{ contest_id|default:'' }}">
          <div class="mb-2">
            <label for="language" class="form-label small fw-semibold">NgÃ´n ngá»¯ láº­p trÃ¬nh</label>
            <select class="form-select form-select-sm" id="language" name="language" required onchange="changeMode()">
              <option value="">-- Chá»n ngÃ´n ngá»¯ --</option>
              <option value="python">ğŸ Python 3</option>
              <option value="pypy">âš¡ PyPy 3</option>
              <option value="cpp">ğŸ’» C++17</option>
              <option value="java">â˜• Java</option>
            </select>
          </div>

          <div class="position-relative mb-3">
            <div id="editor" class="rounded-3 border shadow-sm" style="height:480px;"># Viáº¿t code cá»§a báº¡n táº¡i Ä‘Ã¢y...</div>
            <textarea name="source" id="source" style="display:none;"></textarea>
          </div>

          <!-- ğŸ” Káº¿t quáº£ -->
          <div id="result-box" class="border rounded-3 p-3 bg-light" style="display:none;">
            <div id="result-text" class="fw-semibold text-center text-muted small">â³ Äang cháº¥m...</div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ğŸŒˆ JS Dependencies -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.3/src-min-noconflict/ace.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.3/src-min-noconflict/ext-language_tools.js"></script>

<script>
// âœ… Render Markdown
(function(){
  const src=document.getElementById('md-src');
  const out=document.getElementById('statement');
  if(src && out){
    marked.setOptions({
      breaks:true,gfm:true,
      highlight:(code,lang)=>{try{return hljs.highlight(code,{language:lang||'plaintext'}).value}catch{return code}}
    });
    const html=marked.parse(src.value||'');
    out.innerHTML=DOMPurify.sanitize(html,{USE_PROFILES:{html:true}});
    if(window.renderMathInElement){
      renderMathInElement(out,{delimiters:[{left:"$$",right:"$$",display:true},{left:"$",right:"$",display:false}],throwOnError:false});
    }
    out.querySelectorAll('pre code').forEach(el=>hljs.highlightElement(el));
  }
})();

// âœ… Ace Editor setup
const editor = ace.edit("editor");
editor.setTheme("ace/theme/github");
editor.session.setMode("ace/mode/python");
editor.setOptions({
  enableBasicAutocompletion: true,
  enableLiveAutocompletion: true,
  showPrintMargin: false,
  fontSize: "13px",
  wrap: true,
  highlightActiveLine: true,
  fontFamily: "Fira Code, monospace",
});
function changeMode(){
  const lang=document.getElementById("language").value;
  if(lang==="cpp")editor.session.setMode("ace/mode/c_cpp");
  else if(lang==="java")editor.session.setMode("ace/mode/java");
  else editor.session.setMode("ace/mode/python");
}

// âœ… CÃ¡c nÃºt
document.getElementById("clearBtn").onclick=()=>editor.setValue("");
document.getElementById("sampleBtn").onclick=()=>{
  editor.setValue(`#include <bits/stdc++.h>\nusing namespace std;\nint main(){\n    ios::sync_with_stdio(false);\n    cin.tie(nullptr);\n    // Code here\n    return 0;\n}`);
};
document.getElementById("submitBtn").addEventListener("click", async function(){
  const lang=document.getElementById("language").value;
  const code=editor.getValue().trim();
  const csrf=document.querySelector('[name=csrfmiddlewaretoken]').value;
  const contest_id="{{ contest_id|default:'' }}";
  if(!lang)return alert("âš ï¸ Báº¡n chÆ°a chá»n ngÃ´n ngá»¯!");
  if(code.length===0)return alert("âš ï¸ Báº¡n chÆ°a nháº­p mÃ£ nguá»“n!");
  const box=document.getElementById("result-box"),text=document.getElementById("result-text");
  box.style.display="block"; text.innerHTML="â³ Äang cháº¥m...";
  try{
    const res=await fetch(window.location.href,{
      method:"POST",
      headers:{"X-CSRFToken":csrf,"Content-Type":"application/x-www-form-urlencoded"},
      body:new URLSearchParams({language:lang,source:code,contest_id})
    });
    if(res.ok){
      text.innerHTML="âœ… ÄÃ£ ná»™p bÃ i. Há»‡ thá»‘ng Ä‘ang cháº¥m...";
      setTimeout(()=>{text.innerHTML="ğŸ¯ Káº¿t quáº£: <span class='text-success'>Accepted</span><br>â± 0.45s â€“ 100/100 Ä‘iá»ƒm";},2000);
    }else text.innerHTML="âš ï¸ Lá»—i khi gá»­i bÃ i.";
  }catch(e){text.innerHTML="âŒ KhÃ´ng thá»ƒ káº¿t ná»‘i tá»›i mÃ¡y chá»§.";}
});
</script>

<style>
.markdown-body pre code{background:#f8fafc;border-radius:8px;padding:6px 10px;}
select.form-select{border-radius:10px;padding:0.4rem 0.8rem;}
.btn{font-size:13px;}
.btn-primary{background:linear-gradient(90deg,#2563eb,#1e3a8a);border:none;}
.btn-primary:hover{background:linear-gradient(90deg,#1d4ed8,#1e40af);}
.card{transition:.2s;} .card:hover{box-shadow:0 8px 22px rgba(0,0,0,0.08);}
</style>
{% endblock %}
