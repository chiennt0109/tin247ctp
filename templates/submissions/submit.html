{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container-fluid py-3" style="max-width:1450px;">
  <div class="row g-4">
    <!-- üß© C·ªôt tr√°i: ƒê·ªÅ b√†i -->
    <div class="col-lg-5 col-md-12">
      <div class="card border-0 shadow-sm rounded-4 h-100 p-4" style="font-size:14px;">
        <h5 class="fw-bold text-primary mb-2">{{ problem.title }}</h5>
        <div class="text-muted small mb-2">
          M√£: <b>{{ problem.code }}</b> &nbsp;|&nbsp; ‚è± Gi·ªõi h·∫°n: {{ problem.time_limit|default:"6" }}s
        </div>
        <hr>
        <div id="statement" class="markdown-body" style="max-height:70vh; overflow:auto;">
          {{ problem.statement|safe }}
        </div>
      </div>
    </div>

    <!-- üíª C·ªôt ph·∫£i: Code editor -->
    <div class="col-lg-7 col-md-12 position-relative">
      <div class="card border-0 shadow-sm rounded-4 p-3" style="font-size:14px;">
        <div class="d-flex justify-content-between align-items-center flex-wrap mb-2">
          <h5 class="fw-semibold text-dark mb-2">üöÄ N·ªôp b√†i</h5>
          <a href="{% if contest_id %}/contests/{{ contest_id }}/{% else %}/problems/{% endif %}" 
             class="btn btn-sm btn-outline-secondary rounded-pill shadow-sm">
            ‚¨ÖÔ∏è Quay l·∫°i
          </a>
        </div>

        <form method="POST" id="submitForm">
          {% csrf_token %}
          <input type="hidden" name="contest_id" value="{{ contest_id|default:'' }}">
          <div class="mb-2">
            <label for="language" class="form-label small fw-semibold">Ng√¥n ng·ªØ</label>
            <select class="form-select form-select-sm" id="language" name="language" required onchange="changeMode()">
              <option value="">-- Ch·ªçn ng√¥n ng·ªØ --</option>
              <option value="python">üêç Python 3</option>
              <option value="pypy">‚ö° PyPy 3</option>
              <option value="cpp">üíª C++17</option>
              <option value="java">‚òï Java</option>
            </select>
          </div>

          <div class="position-relative mb-3">
            <div id="editor" class="rounded-3 border shadow-sm" style="height:500px;"># Vi·∫øt code c·ªßa b·∫°n t·∫°i ƒë√¢y...</div>
            <textarea name="source" id="source" style="display:none;"></textarea>
          </div>

          <!-- üîç K·∫øt qu·∫£ hi·ªÉn th·ªã t·∫°i ƒë√¢y -->
          <div id="result-box" class="border rounded-3 p-3 bg-light" style="display:none;">
            <div id="result-text" class="fw-semibold text-center text-muted small">‚è≥ ƒêang ch·∫•m...</div>
          </div>
        </form>
      </div>

      <!-- ‚öôÔ∏è N√∫t c·ªë ƒë·ªãnh -->
      <div class="fixed-btns d-flex justify-content-end gap-2 p-2">
        <button id="submitBtn" type="button" class="btn btn-primary rounded-pill px-4 py-2 fw-semibold shadow-sm">
          üíæ N·ªôp b√†i
        </button>
        <a href="{% if contest_id %}/contests/{{ contest_id }}/{% else %}/problems/{% endif %}" 
           class="btn btn-outline-secondary rounded-pill px-3 py-2 shadow-sm">
          ‚¨ÖÔ∏è Quay l·∫°i
        </a>
      </div>
    </div>
  </div>
</div>

<!-- üåà Ace Editor -->
<script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.3/src-min-noconflict/ace.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.3/src-min-noconflict/ext-language_tools.js"></script>

<script>
  const editor = ace.edit("editor");
  editor.setTheme("ace/theme/github");
  editor.session.setMode("ace/mode/python");
  editor.setOptions({
    enableBasicAutocompletion: true,
    enableLiveAutocompletion: true,
    showPrintMargin: false,
    fontSize: "13px",
    wrap: true,
    highlightActiveLine: true,
    fontFamily: "Fira Code, monospace",
  });

  function changeMode() {
    const lang = document.getElementById("language").value;
    if (lang === "cpp") editor.session.setMode("ace/mode/c_cpp");
    else if (lang === "java") editor.session.setMode("ace/mode/java");
    else editor.session.setMode("ace/mode/python");
  }

  // ‚ö° G·ª≠i b√†i & hi·ªÉn th·ªã k·∫øt qu·∫£ live
  document.getElementById("submitBtn").addEventListener("click", async function() {
    const lang = document.getElementById("language").value;
    const code = editor.getValue().trim();
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const contest_id = "{{ contest_id|default:'' }}";

    if (!lang) return alert("‚ö†Ô∏è B·∫°n ch∆∞a ch·ªçn ng√¥n ng·ªØ!");
    if (code.length === 0) return alert("‚ö†Ô∏è B·∫°n ch∆∞a nh·∫≠p m√£ ngu·ªìn!");

    const box = document.getElementById("result-box");
    const text = document.getElementById("result-text");
    box.style.display = "block";
    text.innerHTML = "‚è≥ ƒêang ch·∫•m b√†i, vui l√≤ng ƒë·ª£i...";

    try {
      const res = await fetch(window.location.href, {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken, "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ language: lang, source: code, contest_id })
      });
      const html = await res.text();
      if (res.ok) {
        text.innerHTML = "‚úÖ ƒê√£ n·ªôp b√†i th√†nh c√¥ng. H·ªá th·ªëng ƒëang ch·∫•m...";
        // gi·∫£ l·∫≠p ki·ªÉm tra ƒë·ªãnh k·ª≥ (mock)
        setTimeout(() => { text.innerHTML = "üéØ K·∫øt qu·∫£: <span class='text-success'>Accepted</span><br>‚è± 0.45s ‚Äì 100/100 ƒëi·ªÉm"; }, 2000);
      } else {
        text.innerHTML = "‚ö†Ô∏è L·ªói khi g·ª≠i b√†i: " + html;
      }
    } catch (err) {
      text.innerHTML = "‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.";
    }
  });
</script>

<style>
.markdown-body pre code {
  background: #f3f4f6;
  border-radius: 8px;
  padding: 6px 10px;
}
select.form-select { border-radius: 10px; padding: 0.4rem 0.8rem; }

.fixed-btns {
  position: sticky;
  bottom: 10px;
  right: 0;
  background: rgba(255,255,255,0.95);
  border-top: 1px solid #e5e7eb;
  border-radius: 12px;
  backdrop-filter: blur(6px);
  z-index: 999;
}

.btn-primary {
  background: linear-gradient(90deg, #2563eb, #1e3a8a);
  border: none;
  font-size: 13px;
}
.btn-primary:hover { background: linear-gradient(90deg, #1d4ed8, #1e40af); }
.btn-outline-secondary { font-size: 13px; }

#result-box {
  animation: fadeIn 0.3s ease-in-out;
  font-size: 13px;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
{% endblock %}
